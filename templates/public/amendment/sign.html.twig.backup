{% extends 'public/layout/base.html.twig' %}

{% block title %}Signer le devis
	{{ quote.numero }}
{% endblock %}

{% block body %}
	<div class="min-h-screen bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900 py-12 px-4 sm:px-6 lg:px-8">
		<div
			class="max-w-4xl mx-auto">
			{# En-t√™te #}
			<div class="text-center mb-8">
				<h1 class="text-3xl font-bold text-white mb-2">Signature du devis</h1>
				<p class="text-xl text-white/80">{{ quote.numero }}</p>
				<p class="text-white/60 mt-2">{{ quote.client.nomComplet }}</p>
			</div>

			{# Alerte d'erreur #}
			<div id="signature-error" class="hidden bg-red-500/20 border border-red-500/30 rounded-xl p-4 mb-6">
				<p class="text-red-300"></p>
			</div>

			{# Messages flash #}
			{% for message in app.flashes('error') %}
				<div class="bg-red-500/20 border border-red-500/30 rounded-xl p-4 mb-6">
					<p class="text-red-300">{{ message }}</p>
				</div>
			{% endfor %}

			{# Carte principale #}
			<div
				class="bg-white/10 backdrop-blur-xl border border-white/20 rounded-2xl p-6 sm:p-8">

				{# Onglets #}
				<div class="flex border-b border-white/20 mb-6">
					<button type="button" data-signature-tab="text" class="px-4 py-3 text-sm font-medium border-b-2 border-blue-500 text-white transition-colors">
						‚úçÔ∏è Taper
					</button>
					<button type="button" data-signature-tab="draw" class="px-4 py-3 text-sm font-medium border-b-2 border-transparent text-white/60 hover:text-white transition-colors">
						‚úèÔ∏è Dessiner
					</button>
					<button type="button" data-signature-tab="upload" class="px-4 py-3 text-sm font-medium border-b-2 border-transparent text-white/60 hover:text-white transition-colors">
						üì§ Uploader
					</button>
				</div>

				{# Formulaire de signature #}
				<form
					id="signature-form" method="post" enctype="multipart/form-data">

					{# Panneau : Taper son nom #}
					<div data-signature-pane="text">
						<div class="mb-6">
							<label for="signature-name" class="block text-sm font-medium text-white mb-2">
								Votre nom complet *
							</label>
							<input type="text" id="signature-name" name="signature_name" class="w-full px-4 py-3 bg-white/5 border border-white/20 rounded-lg text-white placeholder-white/40 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Ex: Jean Dupont" value="{{ quote.client.nomComplet }}">
							<p class="text-white/60 text-sm mt-2">
								En tapant votre nom, vous acceptez les termes de ce devis.
							</p>
						</div>
					</div>

					{# Panneau : Dessiner #}
					<div data-signature-pane="draw" class="hidden">
						<div class="mb-6">
							<label class="block text-sm font-medium text-white mb-2">
								Dessinez votre signature *
							</label>
							<div class="bg-white rounded-lg p-4 border-2 border-white/20">
								<canvas id="signature-canvas" class="w-full" style="height: 200px; touch-action: none;"></canvas>
							</div>
							<div class="flex justify-end mt-2">
								<button type="button" id="clear-signature" class="px-4 py-2 text-sm bg-white/10 hover:bg-white/20 border border-white/20 rounded-lg text-white transition-colors">
									üóëÔ∏è Effacer
								</button>
							</div>
							<p class="text-white/60 text-sm mt-2">
								Utilisez votre souris ou votre doigt (tactile) pour dessiner.
							</p>
						</div>
					</div>

					{# Panneau : Upload #}
					<div data-signature-pane="upload" class="hidden">
						<div class="mb-6">
							<label for="signature-file" class="block text-sm font-medium text-white mb-2">
								Image de votre signature *
							</label>
							<input type="file" id="signature-file" name="signature_file" accept="image/png,image/jpeg" class="w-full px-4 py-3 bg-white/5 border border-white/20 rounded-lg text-white file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-blue-500 file:text-white hover:file:bg-blue-600">
							<p class="text-white/60 text-sm mt-2">
								Formats accept√©s : PNG, JPEG (max 500 Ko)
							</p>

							{# Pr√©visualisation #}
							<div id="signature-preview" class="mt-4 p-4 bg-white/5 rounded-lg border border-white/10 min-h-[100px] flex items-center justify-center">
								<p class="text-white/60 text-sm">Aucun fichier s√©lectionn√©</p>
							</div>
						</div>
					</div>

					{# CSRF Token #}
					<input
					type="hidden" name="_token" value="{{ csrf_token('sign_quote_' ~ quote.id) }}">

					{# Boutons d'action #}
					<div class="flex flex-col sm:flex-row gap-4 mt-8">
						<a href="{{ path('public_quote_view', { id: quote.id, expires: app.request.query.get('expires'), signature: app.request.query.get('signature') }) }}" class="flex-1 px-6 py-3 bg-white/10 hover:bg-white/20 border border-white/20 rounded-lg text-white text-center transition-colors">
							‚Üê Retour
						</a>
						<button type="submit" id="submit-signature" class="flex-1 px-6 py-3 bg-blue-600 hover:bg-blue-700 rounded-lg text-white font-semibold transition-colors">
							‚úÖ Confirmer la signature
						</button>
					</div>
				</form>
			</div>

			{# Informations l√©gales #}
			<div class="mt-6 text-center text-white/40 text-sm">
				<p>En signant ce document, vous acceptez les conditions g√©n√©rales de vente et reconnaissez avoir lu et compris les termes du devis.</p>
				<p class="mt-2">Cette signature √©lectronique a la m√™me valeur qu'une signature manuscrite conform√©ment √† la r√©glementation eIDAS.</p>
			</div>
		</div>
	</div>

	{# Charger Signature Pad depuis CDN #}
	<script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.7/dist/signature_pad.umd.min.js"></script>

	{# Script de gestion de la signature - inline pour √©viter les probl√®mes de chargement #}
	<script>
		document.addEventListener('DOMContentLoaded', function () {
const signatureTabs = document.querySelectorAll('[data-signature-tab]');
const signaturePanes = document.querySelectorAll('[data-signature-pane]');
const signatureForm = document.getElementById('signature-form');
const canvas = document.getElementById('signature-canvas');
const clearButton = document.getElementById('clear-signature');
const submitButton = document.getElementById('submit-signature');

let signaturePad = null;
let currentMethod = 'text';

// Initialiser Signature Pad si le canvas existe
if (canvas) {
signaturePad = new SignaturePad(canvas, {
backgroundColor: 'rgb(255, 255, 255)',
penColor: 'rgb(0, 0, 0)',
minWidth: 1,
maxWidth: 3
});

// Redimensionner le canvas pour qu'il soit responsive
function resizeCanvas() {
const ratio = Math.max(window.devicePixelRatio || 1, 1);
canvas.width = canvas.offsetWidth * ratio;
canvas.height = canvas.offsetHeight * ratio;
canvas.getContext('2d').scale(ratio, ratio);
signaturePad.clear();
}

window.addEventListener('resize', resizeCanvas);
resizeCanvas();
}

// Gestion des onglets
signatureTabs.forEach(tab => {
tab.addEventListener('click', function (e) {
e.preventDefault();
const method = this.dataset.signatureTab;

// Retirer la classe active de tous les onglets
signatureTabs.forEach(t => {
t.classList.remove('border-blue-500', 'text-white');
t.classList.add('border-transparent', 'text-white/60');
});

// Ajouter la classe active √† l'onglet cliqu√©
this.classList.remove('border-transparent', 'text-white/60');
this.classList.add('border-blue-500', 'text-white');

// Cacher tous les panneaux
signaturePanes.forEach(pane => {
pane.classList.add('hidden');
});

// Afficher le panneau correspondant
const activePane = document.querySelector (`[data-signature-pane="${method}"]`);
if (activePane) {
activePane.classList.remove('hidden');
}

currentMethod = method;
});
});

// Bouton Effacer pour le canvas
if (clearButton && signaturePad) {
clearButton.addEventListener('click', function (e) {
e.preventDefault();
signaturePad.clear();
});
}

// Validation du formulaire
if (signatureForm) {
signatureForm.addEventListener('submit', function (e) {
e.preventDefault();

let isValid = false;
let signatureData = {};

// Validation selon la m√©thode choisie
if (currentMethod === 'text') {
const nameInput = document.getElementById('signature-name');
if (nameInput && nameInput.value.trim()) {
isValid = true;
signatureData = {
name: nameInput.value.trim()
};
} else {
showError('Veuillez saisir votre nom pour signer.');
return;
}
} else if (currentMethod === 'draw') {
if (signaturePad && ! signaturePad.isEmpty()) {
isValid = true;
signatureData = {
data: signaturePad.toDataURL('image/png')
};
} else {
showError('Veuillez dessiner votre signature.');
return;
}
} else if (currentMethod === 'upload') {
const fileInput = document.getElementById('signature-file');
if (fileInput && fileInput.files.length > 0) {
const file = fileInput.files[0];

// Validation du fichier
if (! file.type.match('image/png') && ! file.type.match('image/jpeg')) {
showError('Seuls les fichiers PNG et JPEG sont accept√©s.');
return;
}

if (file.size > 500 * 1024) { // 500KB max
showError('Le fichier ne doit pas d√©passer 500 Ko.');
return;
}

isValid = true;
// Le fichier sera upload√© via le formulaire normal
} else {
showError('Veuillez s√©lectionner une image de signature.');
return;
}
}

if (isValid) { // Ajouter la m√©thode et les donn√©es au formulaire
const methodInput = document.createElement('input');
methodInput.type = 'hidden';
methodInput.name = 'signature_method';
methodInput.value = currentMethod;
signatureForm.appendChild(methodInput);

if (currentMethod !== 'upload') {
const dataInput = document.createElement('input');
dataInput.type = 'hidden';
dataInput.name = 'signature_data';
dataInput.value = JSON.stringify(signatureData);
signatureForm.appendChild(dataInput);
}

// Soumettre le formulaire
signatureForm.submit();
}
});
}

// Pr√©visualisation de l'image upload√©e
const fileInput = document.getElementById('signature-file');
const preview = document.getElementById('signature-preview');

if (fileInput && preview) {
fileInput.addEventListener('change', function (e) {
const file = e.target.files[0];

if (file) {
const reader = new FileReader();
reader.onload = function (event) {
preview.innerHTML = `<img src="${
event.target.result
}" alt="Aper√ßu" class="max-w-full max-h-48 rounded border border-white/20">`;
};
reader.readAsDataURL(file);
} else {
preview.innerHTML = '<p class="text-white/60 text-sm">Aucun fichier s√©lectionn√©</p>';
}
});
}

// Fonction pour afficher les erreurs
function showError(message) {
const errorDiv = document.getElementById('signature-error');
if (errorDiv) {
errorDiv.querySelector('p').textContent = message;
errorDiv.classList.remove('hidden');

setTimeout(() => {
errorDiv.classList.add('hidden');
}, 5000);
} else {
alert(message);
}
}
});
	</script>

{% endblock %}
```
