{% extends 'admin/layout/base.html.twig' %}
{% import 'admin/macros/form_fields.html.twig' as form_macros %}

{% block title %}{{ title }} - Administration Delnyx{% endblock %}

{% block page_title %}{{ title }}{% endblock %}

{% block body %}
<div class="space-y-6">
    
    {# Header avec breadcrumb #}
    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 scroll-animate">
        <div>
            <h1 class="text-2xl font-bold text-white">{{ title }}</h1>
            <nav class="flex items-center space-x-2 text-sm text-white/60 mt-1">
                <a href="{{ path('admin_dashboard') }}" class="hover:text-white transition-colors duration-200">Dashboard</a>
                <span>{{ ux_icon('lucide:chevron-right', {class: 'w-4 h-4'}) }}</span>
                <a href="{{ path('admin_quote_index') }}" class="hover:text-white transition-colors duration-200">Devis</a>
                <span>{{ ux_icon('lucide:chevron-right', {class: 'w-4 h-4'}) }}</span>
                <span class="text-white">{{ title }}</span>
            </nav>
        </div>
        <a href="{{ path('admin_quote_index') }}" 
           class="btn-secondary flex items-center gap-2">
            {{ ux_icon('lucide:arrow-left', {class: 'w-4 h-4'}) }}
            Retour à la liste
        </a>
    </div>

    {# Formulaire #}
    <div class="bg-white/10 backdrop-blur-xl border border-white/20 rounded-xl p-6 scroll-animate animate-delay-100"
         data-controller="quote-form flash-messages">
        {{ form_start(form, {'attr': {'class': 'space-y-6', 'data-controller': 'admin-form', 'data-admin-form-target': 'form', 'novalidate': 'novalidate', 'data-action': 'submit->admin-form#handleSubmit'}}) }}
        
        {# Messages flash avec contrôleur Stimulus #}
        <div data-flash-messages-target="container" class="space-y-3 mb-4">
            {% for type, messages in app.flashes %}
                {% for message in messages %}
                    <div data-flash-messages-target="message" 
                         class="glass-card optimized-blur p-4 border-l-4 {% if type == 'success' %}border-emerald-500{% elseif type == 'error' %}border-red-500{% else %}border-blue-500{% endif %}" 
                         data-flash-messages-message-param="{{ loop.index }}">
                        <div class="flex items-center">
                            <div class="w-8 h-8 rounded-lg flex items-center justify-center mr-3 {% if type == 'success' %}bg-emerald-500/20{% else %}bg-red-500/20{% endif %}">
                                {% if type == 'success' %}
                                    {{ ux_icon('lucide:check-circle', {class: 'w-5 h-5 text-emerald-400'}) }}
                                {% else %}
                                    {{ ux_icon('lucide:alert-circle', {class: 'w-5 h-5 text-red-400'}) }}
                                {% endif %}
                            </div>
                            <div class="flex-1">
                                <p class="text-white font-medium">{{ message }}</p>
                            </div>
                        </div>
                    </div>
                {% endfor %}
            {% endfor %}
        </div>
        
        {# Informations générales #}
        <div class="space-y-4">
            <h3 class="text-lg font-semibold text-white flex items-center gap-2">
                {{ ux_icon('lucide:file-text', {class: 'w-5 h-5'}) }}
                Informations générales
            </h3>
            
            {% if quote.id %}
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="form-group">
                        {{ form_label(form.numero, null, {'label_attr': {'class': 'form-label'}}) }}
                        {{ form_widget(form.numero, {'attr': {'class': 'form-input', 'readonly': true, 'disabled': true}}) }}
                        {{ form_help(form.numero) }}
                        {{ form_errors(form.numero) }}
                    </div>
                    {{ form_macros.simple_field(form, 'statut', 'select') }}
                </div>
            {% else %}
                {# En création, le champ numero est caché car généré automatiquement #}
                {{ form_widget(form.numero, {'attr': {'style': 'display: none'}}) }}
            {% endif %}
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="form-group" data-controller="select-search">
                    {{ form_label(form.client, null, {'label_attr': {'class': 'form-label'}}) }}
                    {{ form_widget(form.client, {'attr': {'class': 'form-select', 'data-admin-form-target': 'field'}}) }}
                    {{ form_help(form.client) }}
                    {{ form_errors(form.client) }}
                </div>
                {% if not quote.id %}
                    {{ form_macros.simple_field(form, 'statut', 'select') }}
                {% endif %}
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="form-group" data-controller="date-picker">
                    {{ form_label(form.dateValidite, null, {'label_attr': {'class': 'form-label'}}) }}
                    <div class="relative">
                        {{ form_widget(form.dateValidite, {'attr': {'class': 'form-input pr-10', 'data-admin-form-target': 'field', 'data-date-picker-target': 'input'}}) }}
                        <button type="button" 
                                class="absolute right-3 top-1/2 -translate-y-1/2 text-white/70 hover:text-white transition-colors cursor-pointer focus:outline-none focus:ring-2 focus:ring-blue-500/50 rounded p-1"
                                data-date-picker-target="button"
                                aria-label="Ouvrir le calendrier">
                            {{ ux_icon('lucide:calendar', {class: 'w-5 h-5'}) }}
                        </button>
                    </div>
                    {{ form_help(form.dateValidite) }}
                    {{ form_errors(form.dateValidite) }}
                </div>
                {% if companySettings and companySettings.isTvaEnabled() %}
                    <div class="form-group" data-controller="tva-settings">
                        {{ form_label(form.usePerLineTva, null, {'label_attr': {'class': 'form-label'}}) }}
                        {{ form_widget(form.usePerLineTva, {'attr': {
                            'class': 'form-checkbox',
                            'data-admin-form-target': 'field',
                            'data-tva-settings-target': 'toggle',
                            'data-action': 'change->tva-settings#toggleRate'
                        }}) }}
                        {{ form_help(form.usePerLineTva) }}
                        {{ form_errors(form.usePerLineTva) }}
                    </div>
                {% endif %}
            </div>
        </div>

        {# Lignes de devis #}
        <div class="space-y-4">
            <div class="flex items-center justify-between">
                <h3 class="text-lg font-semibold text-white flex items-center gap-2">
                    {{ ux_icon('lucide:list', {class: 'w-5 h-5'}) }}
                    Lignes de devis
                </h3>
                <button type="button" 
                        class="btn-secondary text-sm py-2 px-4"
                        data-action="click->quote-form#addLine">
                    {{ ux_icon('lucide:plus', {class: 'w-4 h-4'}) }}
                    Ajouter une ligne
                </button>
            </div>
            
            <div data-quote-form-target="linesContainer" class="space-y-4">
                {% for line in form.lines %}
                    <div class="bg-white/5 border border-white/10 rounded-lg p-4 {% if not line.vars.valid %}border-red-500/50{% endif %}" data-line-index="{{ loop.index0 }}">
                        {% if not line.vars.valid %}
                            <div class="mb-4 p-3 bg-red-500/20 border border-red-500/30 rounded-lg">
                                <p class="text-red-300 text-sm font-medium mb-2">Erreurs dans cette ligne :</p>
                                {{ form_errors(line) }}
                                {% for child in line.children %}
                                    {% if not child.vars.valid %}
                                        <div class="mt-1 text-sm">
                                            <strong class="text-red-300">{{ form_label(child) }} :</strong>
                                            {{ form_errors(child) }}
                                        </div>
                                    {% endif %}
                                {% endfor %}
                            </div>
                        {% endif %}
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            {{ form_macros.simple_field(line, 'tariff', 'select') }}
                            {{ form_macros.simple_field(line, 'description') }}
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
                            {{ form_macros.simple_field(line, 'quantity') }}
                            {{ form_macros.simple_field(line, 'unitPrice') }}
                            {% if companySettings and companySettings.isTvaEnabled() and quote.usePerLineTva %}
                                <div data-tva-settings-target="rateWrapper">
                                    {{ form_macros.simple_field(line, 'tvaRate', 'select') }}
                                </div>
                            {% else %}
                                {# Cacher le champ tvaRate si TVA désactivée ou usePerLineTva = false #}
                                <div style="display: none;">
                                    {{ form_widget(line.tvaRate) }}
                                </div>
                            {% endif %}
                        </div>
                        <div class="flex items-center justify-between mt-4 pt-4 border-t border-white/10">
                            <div class="flex items-center gap-2">
                                {{ form_widget(line.isCustom, {'attr': {'class': 'form-checkbox'}}) }}
                                {{ form_label(line.isCustom, null, {'label_attr': {'class': 'text-white/90 cursor-pointer text-sm'}}) }}
                            </div>
                            <button type="button" 
                                    class="text-red-400 hover:text-red-300 text-sm flex items-center gap-1"
                                    data-action="click->quote-form#removeLine">
                                {{ ux_icon('lucide:trash-2', {class: 'w-4 h-4'}) }}
                                Supprimer
                            </button>
                        </div>
                    </div>
                {% endfor %}
            </div>
            
            {# Template pour nouvelle ligne (caché) #}
            <template data-quote-form-target="lineTemplate">
                <div class="bg-white/5 border border-white/10 rounded-lg p-4" data-line-index="__name__">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="form-group">
                            <label class="form-label">Tarif du catalogue</label>
                            <select name="quote[lines][__name__][tariff]" class="form-select" data-admin-form-target="field">
                                <option value="">Aucun</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Description</label>
                            <input type="text" name="quote[lines][__name__][description]" class="form-input" data-admin-form-target="field" required>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
                        <div class="form-group">
                            <label class="form-label">Quantité</label>
                            <input type="number" name="quote[lines][__name__][quantity]" class="form-input" data-admin-form-target="field" min="1" value="1" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Prix unitaire (€)</label>
                            <input type="number" name="quote[lines][__name__][unitPrice]" class="form-input" data-admin-form-target="field" step="0.01" min="0" required>
                        </div>
                        <div class="form-group" data-tva-settings-target="rateWrapper" style="display: none;">
                            <label class="form-label">Taux TVA (%)</label>
                            <select name="quote[lines][__name__][tvaRate]" class="form-select" data-admin-form-target="field">
                                <option value="">Taux global</option>
                                <option value="0.00">0%</option>
                                <option value="5.50">5,5%</option>
                                <option value="10.00">10%</option>
                                <option value="20.00">20%</option>
                            </select>
                        </div>
                    </div>
                    <div class="flex items-center justify-between mt-4 pt-4 border-t border-white/10">
                        <div class="flex items-center gap-2">
                            <input type="checkbox" name="quote[lines][__name__][isCustom]" class="form-checkbox" data-admin-form-target="field">
                            <label class="text-white/90 cursor-pointer text-sm">Ligne personnalisée</label>
                        </div>
                        <button type="button" 
                                class="text-red-400 hover:text-red-300 text-sm flex items-center gap-1"
                                data-action="click->quote-form#removeLine">
                            {{ ux_icon('lucide:trash-2', {class: 'w-4 h-4'}) }}
                            Supprimer
                        </button>
                    </div>
                </div>
            </template>
        </div>

        {# Montants et conditions #}
        <div class="space-y-4">
            <h3 class="text-lg font-semibold text-white flex items-center gap-2">
                {{ ux_icon('lucide:euro', {class: 'w-5 h-5'}) }}
                Montants et conditions
            </h3>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                {{ form_macros.simple_field(form, 'acomptePourcentage') }}
            </div>
            
            {{ form_macros.simple_field(form, 'conditionsPaiement', 'textarea') }}
            {{ form_macros.simple_field(form, 'delaiLivraison') }}
        </div>

        {# Mentions légales #}
        <div class="space-y-4">
            <h3 class="text-lg font-semibold text-white flex items-center gap-2">
                {{ ux_icon('lucide:shield-check', {class: 'w-5 h-5'}) }}
                Mentions légales
            </h3>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                {{ form_macros.simple_field(form, 'typeOperations', 'select') }}
            </div>
            
            <div class="flex items-center gap-2">
                {{ form_widget(form.paiementTvaSurDebits, {'attr': {'class': 'form-checkbox'}}) }}
                {{ form_label(form.paiementTvaSurDebits, null, {'label_attr': {'class': 'text-white/90 cursor-pointer'}}) }}
            </div>
            {% if form.paiementTvaSurDebits.vars.help %}
                <p class="text-white/90 text-sm mt-1">{{ form.paiementTvaSurDebits.vars.help }}</p>
            {% endif %}
        </div>

        {# Notes #}
        <div class="space-y-4">
            <h3 class="text-lg font-semibold text-white flex items-center gap-2">
                {{ ux_icon('lucide:sticky-note', {class: 'w-5 h-5'}) }}
                Notes
            </h3>
            
            {{ form_macros.simple_field(form, 'notes', 'textarea') }}
        </div>

        {# Actions #}
        <div class="flex flex-col sm:flex-row gap-3 pt-6 border-t border-white/20">
            <button type="submit" 
                    class="btn-primary flex items-center justify-center gap-2"
                    data-admin-form-target="submit">
                {{ ux_icon('lucide:save', {class: 'w-4 h-4'}) }}
                {{ quote.id ? 'Modifier le devis' : 'Créer le devis' }}
            </button>
            
            <a href="{{ path('admin_quote_index') }}" 
               class="btn-secondary flex items-center justify-center gap-2">
                {{ ux_icon('lucide:x', {class: 'w-4 h-4'}) }}
                Annuler
            </a>
        </div>

        {# Rendre les champs restants non rendus (comme numero en création) #}
        {{ form_rest(form) }}

        {{ form_end(form, {'render_rest': false}) }}
    </div>
</div>
{% endblock %}

