{% extends 'admin/layout/base.html.twig' %}
{% import 'admin/macros/form_fields.html.twig' as form_macros %}

{% block title %}
	{{ title }}
	- Administration Delnyx
{% endblock %}

{% block page_title %}
	{{ title }}
{% endblock %}

{% block body %}
	<div
		class="space-y-6">

		{# Header avec breadcrumb #}
		<div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 scroll-animate">
			<div>
				<h1 class="text-2xl font-bold text-white">{{ title }}</h1>
				<nav class="flex items-center space-x-2 text-sm text-white/60 mt-1">
					<a href="{{ path('admin_dashboard') }}" class="hover:text-white transition-colors duration-200">Dashboard</a>
					<span>{{ ux_icon('lucide:chevron-right', {class: 'w-4 h-4'}) }}</span>
					<a href="{{ path('admin_credit_note_index') }}" class="hover:text-white transition-colors duration-200">Avoirs</a>
					<span>{{ ux_icon('lucide:chevron-right', {class: 'w-4 h-4'}) }}</span>
					<span class="text-white">{{ title }}</span>
				</nav>
			</div>
			<a href="{{ path('admin_credit_note_index') }}" class="btn-secondary flex items-center gap-2">
				{{ ux_icon('lucide:arrow-left', {class: 'w-4 h-4'}) }}
				Retour √† la liste
			</a>
		</div>

		{# Alerte immutabilit√© si avoir √©mis #}
		{% if creditNote.statutEnum.value == 'issued' %}
			<div class="bg-blue-500/20 border border-blue-500/30 rounded-xl p-4 scroll-animate mb-6">
				<div class="flex items-start gap-3">
					{{ ux_icon('lucide:lock', {class: 'w-5 h-5 text-blue-400 mt-0.5'}) }}
					<div class="flex-1">
						<p class="text-blue-300 font-medium mb-1">Avoir √©mis - Document immuable</p>
						<p class="text-blue-200/80 text-sm">Cet avoir est √©mis et ne peut plus √™tre modifi√©. Les lignes sont en lecture seule.</p>
					</div>
				</div>
			</div>
		{% endif %}

		{# Formulaire #}
		<div class="bg-white/10 backdrop-blur-xl border border-white/20 rounded-xl p-6 scroll-animate animate-delay-100" data-controller="credit-note-form quote-form flash-messages">
			{% set isReadOnly = creditNote.statutEnum.value == 'issued' %}
			{{ form_start(form, {'attr': {'class': 'space-y-6', 'data-controller': 'admin-form', 'data-admin-form-target': 'form', 'novalidate': 'novalidate', 'data-action': 'submit->admin-form#handleSubmit'}}) }}

			{# Messages flash #}
			<div data-flash-messages-target="container" class="space-y-3 mb-4">
				{% for type, messages in app.flashes %}
					{% for message in messages %}
						<div data-flash-messages-target="message" class="glass-card optimized-blur p-4 border-l-4 {% if type == 'success' %}border-emerald-500{% elseif type == 'error' %}border-red-500{% else %}border-blue-500{% endif %}">
							<div class="flex items-center">
								<div class="w-8 h-8 rounded-lg flex items-center justify-center mr-3 {% if type == 'success' %}bg-emerald-500/20{% else %}bg-red-500/20{% endif %}">
									{% if type == 'success' %}
										{{ ux_icon('lucide:check-circle', {class: 'w-5 h-5 text-emerald-400'}) }}
									{% else %}
										{{ ux_icon('lucide:alert-circle', {class: 'w-5 h-5 text-red-400'}) }}
									{% endif %}
								</div>
								<div class="flex-1">
									<p class="text-white font-medium">{{ message }}</p>
								</div>
							</div>
						</div>
					{% endfor %}
				{% endfor %}
			</div>

			{# Informations g√©n√©rales #}
			<div class="space-y-4">
				<h3 class="text-lg font-semibold text-white flex items-center gap-2">
					{{ ux_icon('lucide:file-minus', {class: 'w-5 h-5'}) }}
					Informations g√©n√©rales
				</h3>

				{{ form_widget(form.number, {'attr': {'style': 'display: none'}}) }}

				<div class="grid grid-cols-1 md:grid-cols-2 gap-4">
					<div class="form-group" data-controller="select-search" data-select-search-type="invoice">
						{{ form_label(form.invoice, null, {'label_attr': {'class': 'form-label'}}) }}
						{% if invoice_locked|default(false) or isReadOnly %}
							{{ form_widget(form.invoice, {'attr': {'class': 'form-select', 'data-admin-form-target': 'field', 'disabled': 'disabled'}}) }}
							{% if invoice_locked|default(false) %}
								<p class="text-sm text-white/60 mt-1">La facture est verrouill√©e car l'avoir a √©t√© cr√©√© depuis cette facture.</p>
							{% endif %}
						{% else %}
							{{ form_widget(form.invoice, {'attr': {'class': 'form-select', 'data-admin-form-target': 'field'}}) }}
						{% endif %}
						{# Toujours cr√©er un champ cach√© si le select a une valeur, pour s'assurer que la valeur est soumise m√™me si le select est d√©sactiv√© ou invisible (select-search) #}
						{% if form.invoice.vars.value %}
							{% set invoiceValue = form.invoice.vars.value %}
							{% set invoiceId = attribute(invoiceValue, 'id')|default(invoiceValue) %}
							<input type="hidden" name="{{ form.invoice.vars.full_name }}" value="{{ invoiceId }}" id="{{ form.invoice.vars.id }}_hidden">
						{% endif %}
						{{ form_help(form.invoice) }}
						{{ form_errors(form.invoice) }}
					</div>
					{# Statut affich√© en lecture seule - les transitions passent par les boutons d'action #}
					<div class="form-group">
						<label class="form-label">Statut</label>
						<div class="flex items-center gap-3 h-10">
							{% set statusColors = {
								'draft': 'bg-gray-500/20 text-gray-300 border-gray-500/30',
								'issued': 'bg-blue-500/20 text-blue-300 border-blue-500/30',
								'sent': 'bg-purple-500/20 text-purple-300 border-purple-500/30',
								'applied': 'bg-green-500/20 text-green-300 border-green-500/30',
								'cancelled': 'bg-red-500/20 text-red-300 border-red-500/30'
							} %}
							<span class="inline-flex items-center px-3 py-1.5 rounded-lg text-sm font-medium border {{ statusColors[creditNote.statutEnum.value]|default('bg-gray-500/20 text-gray-300 border-gray-500/30') }}">
								{{ creditNote.statutEnum.label|default('Brouillon') }}
							</span>
							<span class="text-white/50 text-xs">Utilisez les boutons d'action pour changer le statut</span>
						</div>
					</div>
				</div>

				{{ form_macros.simple_field(form, 'reason', 'textarea', {'disabled': isReadOnly}) }}
			</div>

			{# Lignes de la facture d'origine (lecture seule) - Affichage statique si la facture est verrouill√©e #}
			{# Sinon, l'affichage dynamique via JavaScript prendra le relais #}
			{% if creditNote.invoice and invoice_locked|default(false) %}
				{# Afficher les lignes si elles sont charg√©es, sinon le JavaScript les chargera #}
				{% if creditNote.invoice.lines|length > 0 %}
					<div class="space-y-4" data-static-invoice-lines>
						<h3 class="text-lg font-semibold text-white flex items-center gap-2">
							{{ ux_icon('lucide:file-text', {class: 'w-5 h-5'}) }}
							Lignes de la facture d'origine (r√©f√©rence - lecture seule)
						</h3>
						<div class="bg-white/5 border border-white/20 rounded-lg p-4">
							<div class="space-y-3">
								{% for invoiceLine in creditNote.invoice.lines %}
									<div class="flex items-center justify-between text-sm py-2 border-b border-white/10 last:border-0">
										<div class="flex-1">
											<p class="text-white font-medium">{{ invoiceLine.description }}</p>
											<p class="text-white/60 text-xs">
												Qt√©:
												{{ invoiceLine.quantity }}
												√ó
												{{ invoiceLine.unitPrice|number_format(2, ',', ' ') }}
												‚Ç¨
												{% if creditNote.invoice.quote and creditNote.invoice.quote.usePerLineTva and invoiceLine.tvaRate %}
													(TVA
													{{ invoiceLine.tvaRate }}%)
												{% endif %}
											</p>
										</div>
										<div class="text-right">
											<p class="text-white font-semibold">{{ invoiceLine.totalHt|number_format(2, ',', ' ') }}
												‚Ç¨</p>
											<p class="text-white/60 text-xs">HT</p>
										</div>
									</div>
								{% endfor %}
								<div class="pt-2 border-t border-white/20 mt-2">
									<div class="flex items-center justify-between">
										<span class="text-white font-semibold">Total facture initial</span>
										<span class="text-white font-bold">{{ creditNote.invoice.montantTTCFormate }}</span>
									</div>
								</div>
							</div>
						</div>
					</div>
				{% endif %}
			{% endif %}

			{# Lignes d'ajustement (avoir) #}
			<div class="space-y-4" data-controller="tva-per-line">
				<div class="flex items-center justify-between">
					<div>
						<h3 class="text-lg font-semibold text-white flex items-center gap-2">
							{{ ux_icon('lucide:list', {class: 'w-5 h-5'}) }}
							Lignes d'ajustement
						</h3>
						<p class="text-sm text-white/60 mt-1">
							‚ö†Ô∏è Important : Saisissez les montants √†
							<strong>cr√©diter</strong>
							(rembourser) au client.
							<br>Le montant total de l'avoir sera d√©duit du solde d√ª par le client.
						</p>
					</div>
					<div class="flex items-center gap-3">
						{% if companySettings and companySettings.isTvaEnabled() and not isReadOnly %}
							<button type="button" class="btn-secondary text-sm py-2 px-4 flex items-center gap-2" data-tva-per-line-target="toggle" data-action="click->tva-per-line#toggle" data-label-disabled="Appliquer la TVA par ligne" data-label-enabled="D√©sactiver la TVA par ligne">
								{{ ux_icon('lucide:percent', {class: 'w-4 h-4'}) }}
								<span>Appliquer la TVA par ligne</span>
							</button>
						{% endif %}
						{% if not isReadOnly %}
							<button type="button" class="btn-secondary text-sm py-2 px-4" data-action="click->quote-form#addLine">
								{{ ux_icon('lucide:plus', {class: 'w-4 h-4'}) }}
								Ajouter un ajustement
							</button>
						{% endif %}
					</div>
				</div>

				<div data-quote-form-target="linesContainer" class="space-y-4 credit-note-lines-collection" data-admin-form-target="linesContainer">
					{% for line in form.lines %}
						<div class="bg-white/5 border border-white/10 rounded-lg p-4 {% if not line.vars.valid %}border-red-500/50{% endif %}" data-line-index="{{ loop.index0 }}">
							{% if not line.vars.valid %}
								<div class="mb-4 p-3 bg-red-500/20 border border-red-500/30 rounded-lg">
									<p class="text-red-300 text-sm font-medium mb-2">Erreurs dans cette ligne :</p>
									{{ form_errors(line) }}
									{% for child in line.children %}
										{% if not child.vars.valid %}
											<div class="mt-1 text-sm">
												<strong class="text-red-300">{{ form_label(child) }}:</strong>
												{{ form_errors(child) }}
											</div>
										{% endif %}
									{% endfor %}
								</div>
							{% endif %}
							<div class="bg-blue-500/10 border border-blue-500/20 rounded p-3 mb-4">
								<p class="text-blue-300 text-sm">
									<strong>üí° Avoir :</strong>
									Saisissez le montant √†
									<strong>rembourser</strong>
									sur cette ligne.
								</p>
							</div>
							{# Champ sourceLine : s√©lection de la ligne de la facture √† corriger #}
							<div class="mb-4">
								{{ form_label(line.sourceLine, null, {'label_attr': {'class': 'form-label'}}) }}
								{{ form_widget(line.sourceLine, {'attr': {
									'class': 'form-select',
									'data-admin-form-target': 'field',
									'disabled': isReadOnly ? 'disabled' : false
								}}) }}
								{{ form_help(line.sourceLine) }}
								{{ form_errors(line.sourceLine) }}
							</div>
							<div class="grid grid-cols-1 md:grid-cols-2 gap-4">
								{{ form_macros.simple_field(line, 'tariff', 'select', {'disabled': isReadOnly}) }}
								{{ form_macros.simple_field(line, 'description', 'text', {'disabled': isReadOnly}) }}
							</div>
							<div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
								{{ form_macros.simple_field(line, 'quantity', 'number', {'disabled': isReadOnly}) }}
								{{ form_macros.simple_field(line, 'unitPrice', 'number', {'disabled': isReadOnly}) }}
								{% if companySettings and companySettings.isTvaEnabled() %}
									{# Afficher le champ TVA si TVA est activ√©e dans companySettings #}
									{# Les avoirs utilisent toujours la TVA par ligne si TVA est activ√©e #}
										<div data-tva-per-line-target="rateWrapper" style="display: none;"> {{ form_macros.simple_field(line, 'tvaRate', 'select', {'disabled': isReadOnly}) }}
									</div>
								{% else %}
									{# Cacher le champ tvaRate si TVA d√©sactiv√©e #}
									<div style="display: none;">
										{{ form_widget(line.tvaRate) }}
									</div>
								{% endif %}
							</div>
							{% if not isReadOnly %}
								<div class="flex items-center justify-end mt-4 pt-4 border-t border-white/10">
									<button type="button" class="text-red-400 hover:text-red-300 text-sm flex items-center gap-1" data-action="click->quote-form#removeLine">
										{{ ux_icon('lucide:trash-2', {class: 'w-4 h-4'}) }}
										Supprimer
									</button>
								</div>
							{% endif %}
						</div>
					{% endfor %}
				</div>

				{# Template pour nouvelle ligne #}
				<template data-quote-form-target="lineTemplate">
					<div class="bg-white/5 border border-white/10 rounded-lg p-4" data-line-index="__name__">
						<div class="bg-blue-500/10 border border-blue-500/20 rounded p-3 mb-4">
							<p class="text-blue-300 text-sm">
								<strong>üí° Avoir :</strong>
								Saisissez le montant √†
								<strong>rembourser</strong>
								sur cette ligne.
							</p>
						</div>
						{# Champ sourceLine : s√©lection de la ligne de la facture √† corriger #}
						<div class="mb-4">
							<label class="form-label">Ligne de la facture √† corriger (optionnel)</label>
							<select name="{{ form.lines.vars.full_name }}[__name__][sourceLine]" class="form-select" data-admin-form-target="field">
								<option value="">Nouvelle ligne (pas de correction)</option>
							</select>
							<p class="text-xs text-white/60 mt-1">S√©lectionnez une ligne de la facture √† corriger, ou laissez vide pour ajouter une nouvelle ligne</p>
						</div>
						<div class="grid grid-cols-1 md:grid-cols-2 gap-4">
							<div class="form-group">
								<label class="form-label">Tarif du catalogue</label>
								<select name="{{ form.lines.vars.full_name }}[__name__][tariff]" class="form-select" data-admin-form-target="field">
									<option value="">Aucun (ligne personnalis√©e)</option>
									{% for tariff in tariffs|default([]) %}
										<option value="{{ tariff.id }}">{{ tariff.nom }}
											-
											{{ tariff.prix|number_format(2, ',', ' ') }}
											‚Ç¨ ({{ tariff.uniteLabel }})</option>
									{% endfor %}
								</select>
							</div>
							<div class="form-group">
								<label class="form-label">Description</label>
								<input type="text" name="{{ form.lines.vars.full_name }}[__name__][description]" class="form-input" data-admin-form-target="field" required>
							</div>
						</div>
						<div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
							<div class="form-group">
								<label class="form-label">Quantit√©</label>
								<input type="number" name="{{ form.lines.vars.full_name }}[__name__][quantity]" class="form-input" data-admin-form-target="field" min="1" value="1" required>
							</div>
							<div class="form-group">
								<label class="form-label">Prix unitaire (‚Ç¨)</label>
								<input type="number" name="{{ form.lines.vars.full_name }}[__name__][unitPrice]" class="form-input" data-admin-form-target="field" step="0.01" min="0" required>
							</div>
							{% if companySettings and companySettings.isTvaEnabled() %}
								<div class="form-group" data-tva-per-line-target="rateWrapper" style="display: none;">
									<label class="form-label">Taux TVA (%)</label>
									<select name="{{ form.lines.vars.full_name }}[__name__][tvaRate]" class="form-select" data-admin-form-target="field">
										<option value="">Taux global</option>
										<option value="0.00">0%</option>
										<option value="5.50">5,5%</option>
										<option value="10.00">10%</option>
										<option value="20.00">20%</option>
									</select>
								</div>
							{% else %}
								<div class="form-group" style="display: none;">
									<label class="form-label">Taux TVA (%)</label>
									<select name="{{ form.lines.vars.full_name }}[__name__][tvaRate]" class="form-select" data-admin-form-target="field">
										<option value="">Taux global</option>
									</select>
								</div>
							{% endif %}
						</div>
						<div class="flex items-center justify-end mt-4 pt-4 border-t border-white/10">
							<button type="button" class="text-red-400 hover:text-red-300 text-sm flex items-center gap-1" data-action="click->quote-form#removeLine">
								{{ ux_icon('lucide:trash-2', {class: 'w-4 h-4'}) }}
								Supprimer
							</button>
						</div>
					</div>
				</template>
			</div>

			{# Actions #}
			<div class="flex flex-col sm:flex-row gap-3 pt-6 border-t border-white/20">
				<button type="submit" class="btn-primary flex items-center justify-center gap-2" data-admin-form-target="submit">
					{{ ux_icon('lucide:save', {class: 'w-4 h-4'}) }}
					{{ creditNote.id ? 'Modifier l\'avoir' : 'Cr√©er l\'avoir' }}
				</button>
				<a href="{{ path('admin_credit_note_index') }}" class="btn-secondary flex items-center justify-center gap-2">
					{{ ux_icon('lucide:x', {class: 'w-4 h-4'}) }}
					Annuler
				</a>
			</div>

			{{ form_rest(form) }}
			{{ form_end(form, {'render_rest': false}) }}
		</div>
	</div>
{% endblock %}
