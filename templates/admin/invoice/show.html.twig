{% extends 'admin/layout/base.html.twig' %}

{% block title %}Facture
	{{ invoice.numero }}
	- Administration Delnyx
{% endblock %}

{% block page_title %}Facture
	{{ invoice.numero }}
{% endblock %}

{% block body %}
	{% set avoirsEmis = invoice.creditNotes|filter(cn => cn.statutEnum.value == 'issued') %}
	{% set totalAvoirsEmis = 0 %}
	{% for creditNote in avoirsEmis %}
		{# Les avoirs sont stockés en montants négatifs, donc on additionne directement #}
		{% set totalAvoirsEmis = totalAvoirsEmis + (creditNote.montantTTC|number_format(2, '.', '')) %}
	{% endfor %}
	<div
		class="space-y-6">

		{# Header avec breadcrumb #}
		<div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 scroll-animate">
			<div>
				<h1 class="text-2xl font-bold text-white">Facture
					{{ invoice.numero }}</h1>
				<nav class="flex items-center space-x-2 text-sm text-white/60 mt-1">
					<a href="{{ path('admin_dashboard') }}" class="hover:text-white transition-colors duration-200">Dashboard</a>
					<span>{{ ux_icon('lucide:chevron-right', {class: 'w-4 h-4'}) }}</span>
					<a href="{{ path('admin_invoice_index') }}" class="hover:text-white transition-colors duration-200">Factures</a>
					<span>{{ ux_icon('lucide:chevron-right', {class: 'w-4 h-4'}) }}</span>
					<span class="text-white">{{ invoice.numero }}</span>
				</nav>
			</div>
			<div class="flex gap-3">
				<a href="{{ path('admin_invoice_index') }}" class="btn-secondary flex items-center gap-2">
					{{ ux_icon('lucide:arrow-left', {class: 'w-4 h-4'}) }}
					Retour
				</a>
			</div>
		</div>

		{# Alerte immutabilité si facture émise #}
		{% if invoice.statutEnum and invoice.statutEnum.isEmitted() %}
			<div class="bg-blue-500/20 border border-blue-500/30 rounded-xl p-4 scroll-animate">
				<div class="flex items-start gap-3">
					{{ ux_icon('lucide:lock', {class: 'w-5 h-5 text-blue-400 mt-0.5'}) }}
					<div class="flex-1">
						<p class="text-blue-300 font-medium mb-1">Facture émise - Document immuable</p>
						<p class="text-blue-200/80 text-sm">Cette facture est émise et ne peut plus être modifiée. Pour apporter des corrections, créez un avoir.</p>
					</div>
				</div>
			</div>
		{% endif %}

		{# Informations principales #}
		<div
			class="grid grid-cols-1 lg:grid-cols-3 gap-6">

			{# Colonne principale #}
			<div
				class="lg:col-span-2 space-y-6">

				{# Informations de la facture #}
				<div class="bg-white/10 backdrop-blur-xl border border-white/20 rounded-xl p-6 scroll-animate">
					<h2 class="text-xl font-semibold text-white mb-6 flex items-center gap-2">
						{{ ux_icon('lucide:receipt', {class: 'w-5 h-5'}) }}
						Informations de la facture
					</h2>

					<div class="grid grid-cols-1 md:grid-cols-2 gap-6">
						<div>
							<p class="text-sm text-white/60 mb-1">Client</p>
							<p class="text-white font-medium">{{ invoice.client.nomComplet }}</p>
							<p class="text-sm text-white/60">{{ invoice.client.email }}</p>
						</div>

						<div>
							<p class="text-sm text-white/60 mb-1">Statut</p>
							{% set status = invoice.statutEnum %}
							<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium
																											                            {% if status.value == 'draft' %}bg-gray-500/20 text-gray-300
																											                            {% elseif status.value == 'issued' %}bg-blue-500/20 text-blue-300
																											                            {% elseif status.value == 'sent' %}bg-purple-500/20 text-purple-300
																											                            {% elseif status.value == 'paid' %}bg-green-500/20 text-green-300
																											                            {% elseif status.value == 'cancelled' %}bg-gray-600/20 text-gray-400
																											                            {% else %}bg-gray-500/20 text-gray-300{% endif %}">
								{{ status.label }}
							</span>
						</div>

						<div>
							<p class="text-sm text-white/60 mb-1">Date de création</p>
							<p class="text-white">{{ invoice.dateCreation|date('d/m/Y à H:i') }}</p>
						</div>

						<div>
							<p class="text-sm text-white/60 mb-1">Date d'échéance</p>
							<p class="text-white {% if invoice.isEnRetard %}text-red-400 font-semibold{% endif %}">
								{{ invoice.dateEcheance|date('d/m/Y') }}
								{% if invoice.isEnRetard %}
									<span class="text-xs ml-2">({{ invoice.joursRetard }}
										jour{{ invoice.joursRetard > 1 ? 's' : '' }}
										de retard)</span>
								{% endif %}
							</p>
						</div>

						{% if invoice.dateEnvoi %}
							<div>
								<p class="text-sm text-white/60 mb-1">Date d'envoi</p>
								<p class="text-white">{{ invoice.dateEnvoi|date('d/m/Y à H:i') }}</p>
								{% if invoice.sentCount > 0 %}
									<p class="text-xs text-white/60">Envoyée
										{{ invoice.sentCount }}
										fois</p>
								{% endif %}
								{% if invoice.deliveryChannel %}
									<p class="text-xs text-white/60">Canal :
										{{ invoice.deliveryChannel }}</p>
								{% endif %}
							</div>
						{% endif %}

						{% if invoice.quote %}
							<div>
								<p class="text-sm text-white/60 mb-1">Devis associé</p>
								<a href="{{ path('admin_quote_show', {id: invoice.quote.id}) }}" class="text-blue-400 hover:text-blue-300 transition-colors">
									{{ invoice.quote.numero }}
								</a>
								{% if quoteAmendments|length > 0 %}
									<p class="text-xs text-yellow-400 mt-1">
										⚠️ Ce devis a
										{{ quoteAmendments|length }}
										avenant{{ quoteAmendments|length > 1 ? 's' : '' }}
									</p>
								{% endif %}
							</div>
						{% endif %}

						{% if invoice.datePaiement %}
							<div>
								<p class="text-sm text-white/60 mb-1">Date de paiement</p>
								<p class="text-white">{{ invoice.datePaiement|date('d/m/Y à H:i') }}</p>
							</div>
						{% endif %}
					</div>
				</div>

				{# Lignes de la facture #}
				<div class="bg-white/10 backdrop-blur-xl border border-white/20 rounded-xl p-6 scroll-animate animate-delay-100">
					<h2 class="text-xl font-semibold text-white mb-6 flex items-center gap-2">
						{{ ux_icon('lucide:list', {class: 'w-5 h-5'}) }}
						Lignes de la facture
					</h2>

					{% if invoice.lines|length > 0 %}
						{# Version desktop : table #}
						<div class="hidden md:block overflow-x-auto">
							<table class="w-full">
								<thead class="bg-white/5 border-b border-white/20">
									<tr>
										<th class="px-4 py-3 text-left text-xs font-semibold text-white/80 uppercase">Description</th>
										<th class="px-4 py-3 text-right text-xs font-semibold text-white/80 uppercase">Qté</th>
										<th class="px-4 py-3 text-right text-xs font-semibold text-white/80 uppercase">Prix unitaire</th>
										{% if companySettings and companySettings.isTvaEnabled() %}
											<th class="px-4 py-3 text-right text-xs font-semibold text-white/80 uppercase">TVA</th>
											<th class="px-4 py-3 text-right text-xs font-semibold text-white/80 uppercase">Total HT</th>
										{% endif %}
										<th class="px-4 py-3 text-right text-xs font-semibold text-white/80 uppercase">Total TTC</th>
									</tr>
								</thead>
								<tbody class="divide-y divide-white/10">
									{% for line in invoice.lines %}
										<tr>
											<td class="px-4 py-3 text-white">{{ line.description }}</td>
											<td class="px-4 py-3 text-right text-white">{{ line.quantity }}</td>
											<td class="px-4 py-3 text-right text-white">{{ line.unitPrice|number_format(2, ',', ' ') }}
												€</td>
											{% if companySettings and companySettings.isTvaEnabled() %}
												<td class="px-4 py-3 text-right text-white">
													{% if invoice.quote and invoice.quote.usePerLineTva and line.tvaRate %}
														{{ line.tvaRate }}%
													{% elseif invoice.quote and invoice.quote.usePerLineTva %}
														{{ invoice.quote.tauxTVA }}%
													{% elseif invoice.quote %}
														{{ invoice.quote.tauxTVA }}%
													{% else %}
														-
													{% endif %}
												</td>
												<td class="px-4 py-3 text-right text-white font-medium">{{ line.totalHt|number_format(2, ',', ' ') }}
													€</td>
											{% endif %}
											<td class="px-4 py-3 text-right text-white font-medium">{{ line.totalTtcFormatted }}</td>
										</tr>
									{% endfor %}
								</tbody>
							</table>
						</div>

						{# Version mobile : cards #}
						<div class="md:hidden space-y-4">
							{% for line in invoice.lines %}
								<div class="bg-white/5 border border-white/10 rounded-lg p-4">
									<div class="mb-3">
										<h3 class="text-white font-medium mb-1">{{ line.description }}</h3>
									</div>
									<div class="space-y-2 text-sm">
										<div class="flex justify-between">
											<span class="text-white/60">Quantité</span>
											<span class="text-white">{{ line.quantity }}</span>
										</div>
										<div class="flex justify-between">
											<span class="text-white/60">Prix unitaire</span>
											<span class="text-white">{{ line.unitPrice|number_format(2, ',', ' ') }}
												€</span>
										</div>
										{% if companySettings and companySettings.isTvaEnabled() %}
											<div class="flex justify-between">
												<span class="text-white/60">TVA</span>
												<span class="text-white">
													{% if invoice.quote and invoice.quote.usePerLineTva and line.tvaRate %}
														{{ line.tvaRate }}%
													{% elseif invoice.quote and invoice.quote.usePerLineTva %}
														{{ invoice.quote.tauxTVA }}%
													{% elseif invoice.quote %}
														{{ invoice.quote.tauxTVA }}%
													{% else %}
														-
													{% endif %}
												</span>
											</div>
											<div class="flex justify-between pt-2 border-t border-white/10">
												<span class="text-white/60">Total HT</span>
												<span class="text-white font-medium">{{ line.totalHt|number_format(2, ',', ' ') }}
													€</span>
											</div>
										{% endif %}
										<div class="flex justify-between {% if companySettings and companySettings.isTvaEnabled() %}{% else %}pt-2 border-t border-white/10{% endif %}">
											<span class="text-white font-medium">Total TTC</span>
											<span class="text-white font-bold">{{ line.totalTtcFormatted }}</span>
										</div>
									</div>
								</div>
							{% endfor %}
						</div>
					{% else %}
						<p class="text-white/60 text-center py-8">Aucune ligne dans cette facture</p>
					{% endif %}
				</div>

				{# Avoirs #}
				{% if invoice.creditNotes|length > 0 %}
					<div class="bg-white/10 backdrop-blur-xl border border-white/20 rounded-xl p-6 scroll-animate animate-delay-200">
						<h2 class="text-xl font-semibold text-white mb-6 flex items-center gap-2">
							{{ ux_icon('lucide:file-minus', {class: 'w-5 h-5'}) }}
							Avoirs ({{ invoice.creditNotes|length }})
						</h2>

						<div class="space-y-3">
							{% for creditNote in invoice.creditNotes %}
								<div class="bg-white/5 border border-white/10 rounded-lg p-4">
									<div class="flex items-start justify-between">
										<div class="flex-1">
											<div class="flex items-center gap-2 mb-2">
												<a href="{{ path('admin_credit_note_show', {id: creditNote.id}) }}" class="text-blue-400 hover:text-blue-300 transition-colors font-medium">
													{{ creditNote.number }}
												</a>
												{% set status = creditNote.statutEnum %}
												<span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium
													{% if status.value == 'draft' %}bg-gray-500/20 text-gray-300
													{% elseif status.value == 'issued' %}bg-green-500/20 text-green-300
													{% elseif status.value == 'sent' %}bg-blue-500/20 text-blue-300
													{% elseif status.value == 'cancelled' %}bg-gray-600/20 text-gray-400
													{% else %}bg-gray-500/20 text-gray-300{% endif %}">
													{{ status.label }}
												</span>
											</div>
											<p class="text-sm text-white/80 mb-1">{{ creditNote.reason }}</p>
											<div class="flex items-center gap-4 text-xs text-white/60">
												<span>{{ creditNote.dateCreation|date('d/m/Y') }}</span>
												{% if creditNote.dateEmission %}
													<span>Émis le
														{{ creditNote.dateEmission|date('d/m/Y') }}</span>
												{% endif %}
												<span class="font-medium text-white">{{ creditNote.montantTTCFormatted }}</span>
											</div>
											{% if creditNote.isTotal %}
												<p class="text-xs text-red-400 mt-2">⚠️ Cet avoir annule complètement la facture</p>
											{% endif %}
										</div>
									</div>
								</div>
							{% endfor %}
						</div>

						{# Afficher le total des avoirs émis et le solde final #}
						{% if avoirsEmis|length > 0 %}
							<div class="mt-4 pt-4 border-t border-white/20">
								<div class="flex justify-between items-center text-sm">
									<span class="text-white/60">Total des avoirs émis</span>
									<span class="text-white font-medium">{{ totalAvoirsEmis|number_format(2, ',', ' ') }}
										€</span>
								</div>
								<div class="flex justify-between items-center mt-2 pt-2 border-t border-white/10">
									<span class="text-white font-semibold">Solde final</span>
									{% set soldeFinal = invoice.soldeFinal|number_format(2, '.', '') %}
									<span class="text-white font-bold {% if soldeFinal <= 0 %}text-green-400{% else %}text-white{% endif %}">
										{{ invoice.soldeFinalFormate }}
									</span>
								</div>
							</div>
						{% endif %}
					</div>
				{% endif %}

				{# Conditions et notes #}
				{% if invoice.conditionsPaiement or invoice.delaiPaiement or invoice.penalitesRetard or invoice.notes %}
					<div class="bg-white/10 backdrop-blur-xl border border-white/20 rounded-xl p-6 scroll-animate animate-delay-200">
						<h2 class="text-xl font-semibold text-white mb-6 flex items-center gap-2">
							{{ ux_icon('lucide:info', {class: 'w-5 h-5'}) }}
							Conditions et notes
						</h2>

						<div class="space-y-4">
							{% if invoice.conditionsPaiement %}
								<div>
									<p class="text-sm text-white/60 mb-1">Conditions de paiement</p>
									<p class="text-white">{{ invoice.conditionsPaiement }}</p>
								</div>
							{% endif %}

							{% if invoice.delaiPaiement %}
								<div>
									<p class="text-sm text-white/60 mb-1">Délai de paiement</p>
									<p class="text-white">{{ invoice.delaiPaiement }}
										jour{{ invoice.delaiPaiement > 1 ? 's' : '' }}</p>
								</div>
							{% endif %}

							{% if invoice.penalitesRetard %}
								<div>
									<p class="text-sm text-white/60 mb-1">Pénalités de retard</p>
									<p class="text-white">{{ invoice.penalitesRetard }}% par jour</p>
									{% if invoice.isEnRetard %}
										<p class="text-red-400 text-sm mt-1">Montant des pénalités :
											{{ invoice.montantPenalites|number_format(2, ',', ' ') }}
											€</p>
									{% endif %}
								</div>
							{% endif %}

							{% if invoice.notes %}
								<div>
									<p class="text-sm text-white/60 mb-1">Notes</p>
									<p class="text-white">{{ invoice.notes }}</p>
								</div>
							{% endif %}
						</div>
					</div>
				{% endif %}
			</div>

			{# Colonne latérale #}
			<div
				class="space-y-6">

				{# Montants #}
				<div class="bg-white/10 backdrop-blur-xl border border-white/20 rounded-xl p-6 scroll-animate animate-delay-100">
					<h2 class="text-xl font-semibold text-white mb-6 flex items-center gap-2">
						{{ ux_icon('lucide:calculator', {class: 'w-5 h-5'}) }}
						Montants
					</h2>

					<div class="space-y-4">
						{% if companySettings and companySettings.isTvaEnabled() %}
							<div class="flex justify-between items-center">
								<span class="text-white/60">Montant HT</span>
								<span class="text-white font-semibold">{{ invoice.montantHTFormate }}</span>
							</div>

							{% if invoice.quote and invoice.quote.usePerLineTva %}
								{# TVA par ligne : afficher le détail des taux #}
								{# Note: line.totalHt est maintenant en euros (DECIMAL) #}
								{% set totalTvaByRate = {} %}
									{% for line in invoice.lines %}
									{% set rate = line.tvaRate ? line.tvaRate : invoice.quote.tauxTVA %}
									{# line.totalHt est maintenant en euros (DECIMAL) #}
									{% set totalHtEuros = line.totalHt|number_format(2, '.', '') %}
									{% set tvaAmountEuros = (totalHtEuros * (rate|number_format(2, '.', '') / 100))|round(2) %}
										{% if totalTvaByRate[rate] is not defined %}
										{% set totalTvaByRate = totalTvaByRate|merge({(rate): {'rate': rate, 'tva': tvaAmountEuros}}) %}
									{% else %}
										{% set totalTvaByRate = totalTvaByRate|merge({(rate): {'rate': rate, 'tva': totalTvaByRate[rate].tva + tvaAmountEuros}}) %}
									{% endif %}
								{% endfor %}
								{% if totalTvaByRate|length > 0 %}
									<div class="space-y-2">
										{% for rate, detail in totalTvaByRate %}
											<div class="flex justify-between items-center">
												<span class="text-white/60">TVA
													{{ detail.rate }}%</span>
												<span class="text-white font-semibold">{{ detail.tva|number_format(2, ',', ' ') }}
													€</span>
											</div>
										{% endfor %}
										<div class="pt-2 border-t border-white/10 flex justify-between items-center">
											<span class="text-white/60 font-medium">Total TVA</span>
											<span class="text-white font-semibold">{{ invoice.montantTVAFormate }}</span>
										</div>
									</div>
								{% else %}
									<div class="flex justify-between items-center">
										<span class="text-white/60">TVA</span>
										<span class="text-white font-semibold">{{ invoice.montantTVAFormate }}</span>
									</div>
								{% endif %}
							{% else %}
								{# TVA globale #}
								<div class="flex justify-between items-center">
									<span class="text-white/60">TVA
										{% if invoice.quote %}
											({{ invoice.quote.tauxTVA }}%)
										{% endif %}
									</span>
									<span class="text-white font-semibold">{{ invoice.montantTVAFormate }}</span>
								</div>
							{% endif %}

							<div class="pt-2 border-t border-white/10 flex justify-between items-center">
								<span class="text-white/60">Total TTC initial</span>
								<span class="text-white font-semibold">{{ invoice.montantTTCFormate }}</span>
							</div>
						{% else %}
							{# TVA désactivée : afficher TTC au lieu de HT #}
							<div class="flex justify-between items-center">
								<span class="text-white/60">Total TTC initial</span>
								<span class="text-white font-semibold">{{ invoice.montantTTCFormate }}</span>
							</div>
						{% endif %}

						{# Afficher les avoirs émis s'il y en a #}
						{% if avoirsEmis|length > 0 %}
							<div class="pt-4 border-t border-white/20">
								<p class="text-sm text-white/60 mb-2">Avoirs émis ({{ avoirsEmis|length }})</p>
								{% for creditNote in avoirsEmis %}
									<div class="flex justify-between items-center text-sm mb-1">
										<span class="text-white/60">{{ creditNote.number }}</span>
										<span class="text-white">-
											{{ creditNote.montantTTCFormatted }}</span>
									</div>
								{% endfor %}
								<div class="pt-2 border-t border-white/10 flex justify-between items-center mt-2">
									<span class="text-white/60 font-medium">Total avoirs</span>
									{# Les avoirs sont stockés en négatif, donc on affiche la valeur absolue avec un signe moins #}
									<span class="text-white font-semibold">{{ totalAvoirsEmis|number_format(2, ',', ' ') }}
										€</span>
								</div>
							</div>
						{% endif %}

						<div class="pt-4 border-t border-white/20 flex justify-between items-center">
							<span class="text-white font-semibold text-lg">Total TTC final</span>
							<span class="text-white font-bold text-xl">
								{{ invoice.soldeFinalFormate }}
							</span>
						</div>

						{% if invoice.montantAcompte and invoice.montantAcompte > 0 %}
							{% set totalCorrige = invoice.totalCorrected|number_format(2, '.', '') %}
							{% set montantAcompte = invoice.montantAcompte|number_format(2, '.', '') %}
							{% set resteAPayer = totalCorrige - montantAcompte %}
							<div class="pt-4 border-t border-white/20">
								<div class="flex justify-between items-center mb-2">
									<span class="text-white/60">Acompte</span>
									<span class="text-white font-semibold">
										{{ invoice.montantAcompte|number_format(2, ',', ' ') }} €
									</span>
								</div>
								<div class="flex justify-between items-center">
									<span class="text-white font-medium">Reste à payer</span>
									<span class="text-white font-bold">
										{{ resteAPayer|number_format(2, ',', ' ') }} €
									</span>
								</div>
							</div>
						{% endif %}
					</div>
				</div>

				{# Actions #}
				<div class="bg-white/10 backdrop-blur-xl border border-white/20 rounded-xl p-6 scroll-animate animate-delay-200">
					<h2 class="text-xl font-semibold text-white mb-6 flex items-center gap-2">
						{{ ux_icon('lucide:zap', {class: 'w-5 h-5'}) }}
						Actions
					</h2>

					<div class="space-y-3">
						{{ component('EntityActions', {
							entity: invoice,
							type: 'invoice',
							layout: 'vertical'
						}) }}
					</div>
				</div>

				{# Magic Links - Liens signés pour le client #}
				{% if invoice.statutEnum.value in ['issued', 'sent'] %}
					<div class="scroll-animate animate-delay-300">
						{{ component('MagicLinks', {
							entity: invoice,
							entityType: 'invoice',
							availableActions: ['view', 'pay']
						}) }}
					</div>
				{% endif %}
			</div>
		</div>
	</div>
	
	{# Modal d'envoi d'email #}
	{{ component('EmailModal') }}
{% endblock %}
