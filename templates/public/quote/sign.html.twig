{% extends 'public/layout/base.html.twig' %}

{% block title %}Signer le devis {{ quote.numero }} - Delnyx{% endblock %}

{% block body %}
<div class="max-w-3xl mx-auto">
    {% include 'public/components/document_header.html.twig' with {
        title: 'Signature du devis',
        numero: quote.numero,
        client: quote.client,
        status: quote.statut
    } %}

    {# Messages flash #}
    {% for message in app.flashes('error') %}
        <div class="bg-red-500/20 border border-red-500/30 rounded-xl p-4 mb-6">
            <p class="text-red-300">
                {{ ux_icon('lucide:alert-circle', {class: 'w-5 h-5 inline mr-2'}) }}
                {{ message }}
            </p>
        </div>
    {% endfor %}

    {# Formulaire de signature simplifié - méthode draw uniquement #}
    <div class="bg-white/10 backdrop-blur-xl border border-white/20 rounded-xl p-6 sm:p-8 mb-6">
        <h2 class="text-xl font-semibold text-white mb-6">Signez ci-dessous</h2>

        <form id="signature-form" method="post">
            <div class="mb-6">
                <label class="block text-sm font-medium text-white mb-2">
                    Dessinez votre signature *
                </label>
                <div class="bg-white rounded-lg p-4 border-2 border-white/20 relative">
                    <canvas id="signature-canvas" class="w-full cursor-crosshair" style="height: 200px; touch-action: none;"></canvas>
                </div>
                <div class="flex justify-end mt-2">
                    <button type="button" id="clear-signature" class="px-4 py-2 text-sm bg-white/10 hover:bg-white/20 border border-white/20 rounded-lg text-white transition-colors">
                        {{ ux_icon('lucide:trash-2', {class: 'w-4 h-4 inline mr-2'}) }}
                        Effacer
                    </button>
                </div>
                <p class="text-white/60 text-sm mt-2">
                    {{ ux_icon('lucide:pen-tool', {class: 'w-4 h-4 inline mr-1'}) }}
                    Utilisez votre souris ou votre doigt (tactile) pour dessiner votre signature.
                </p>
            </div>

            {# Champ caché pour les données de signature #}
            <input type="hidden" name="signature_method" value="draw">
            <input type="hidden" name="signature_data" id="signature-data" value="">

            {# CSRF Token #}
            <input type="hidden" name="_token" value="{{ csrf_token('sign_quote_' ~ quote.id) }}">

            {# Boutons d'action #}
            <div class="flex flex-col sm:flex-row gap-4">
                <a href="{{ magic_link(quote, 'view') }}" class="flex-1 px-6 py-3 rounded-lg font-semibold transition-colors text-center bg-white/10 hover:bg-white/20 border border-white/20 text-white">
                    ← Retour
                </a>
                <button type="submit" id="submit-signature" class="flex-1 px-6 py-3 rounded-lg font-semibold transition-colors text-center bg-blue-600 hover:bg-blue-700 text-white">
                    {{ ux_icon('lucide:check-circle', {class: 'w-5 h-5 inline mr-2'}) }}
                    Confirmer la signature
                </button>
            </div>
        </form>
    </div>

    {# Informations légales #}
    <div class="bg-white/5 border border-white/10 rounded-lg p-4 text-center text-white/60 text-sm">
        <p class="mb-2">
            {{ ux_icon('lucide:shield-check', {class: 'w-4 h-4 inline mr-1'}) }}
            Cette signature électronique a la même valeur qu'une signature manuscrite conformément à la réglementation eIDAS.
        </p>
        <p>En signant ce document, vous acceptez les conditions générales de vente.</p>
    </div>
</div>

{# Charger Signature Pad depuis CDN #}
<script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.7/dist/signature_pad.umd.min.js"></script>

{# Script de gestion de la signature #}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const signatureForm = document.getElementById('signature-form');
    const canvas = document.getElementById('signature-canvas');
    const clearButton = document.getElementById('clear-signature');
    const signatureDataInput = document.getElementById('signature-data');

    let signaturePad = null;

    // Initialiser Signature Pad
    if (canvas) {
        signaturePad = new SignaturePad(canvas, {
            backgroundColor: 'rgb(255, 255, 255)',
            penColor: 'rgb(0, 0, 0)',
            minWidth: 1,
            maxWidth: 3
        });

        function resizeCanvas() {
            const ratio = Math.max(window.devicePixelRatio || 1, 1);
            const wasEmpty = signaturePad.isEmpty();
            canvas.width = canvas.offsetWidth * ratio;
            canvas.height = canvas.offsetHeight * ratio;
            canvas.getContext('2d').scale(ratio, ratio);
            if (wasEmpty) {
                signaturePad.clear();
            }
        }

        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();
    }

    // Bouton Effacer
    if (clearButton && signaturePad) {
        clearButton.addEventListener('click', function(e) {
            e.preventDefault();
            signaturePad.clear();
        });
    }

    // Validation du formulaire
    if (signatureForm) {
        signatureForm.addEventListener('submit', function(e) {
            e.preventDefault();

            if (!signaturePad || signaturePad.isEmpty()) {
                alert('Veuillez dessiner votre signature avant de confirmer.');
                return;
            }

            // Extraire les données de signature en base64
            const signatureData = {
                data: signaturePad.toDataURL('image/png')
            };

            signatureDataInput.value = JSON.stringify(signatureData);
            signatureForm.submit();
        });
    }
});
</script>
{% endblock %}
