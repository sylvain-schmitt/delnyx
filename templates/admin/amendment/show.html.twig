{% extends 'admin/layout/base.html.twig' %}

{% block title %}Avenant
	{{ amendment.numero }}
	- Administration Delnyx
{% endblock %}

{% block page_title %}Avenant
	{{ amendment.numero }}
{% endblock %}

{% block body %}
<div
	class="space-y-6">

	{# Header avec breadcrumb #}
	<div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 scroll-animate">
		<div>
			<h1 class="text-2xl font-bold text-white">Avenant
				{{ amendment.numero }}</h1>
			<nav class="flex items-center space-x-2 text-sm text-white/60 mt-1">
				<a href="{{ path('admin_dashboard') }}" class="hover:text-white transition-colors duration-200">Dashboard</a>
				<span>{{ ux_icon('lucide:chevron-right', {class: 'w-4 h-4'}) }}</span>
				<a href="{{ path('admin_amendment_index') }}" class="hover:text-white transition-colors duration-200">Avenants</a>
				<span>{{ ux_icon('lucide:chevron-right', {class: 'w-4 h-4'}) }}</span>
				<span class="text-white">{{ amendment.numero }}</span>
			</nav>
		</div>
		<div
			class="flex gap-3 flex-wrap">
			{# Bouton Retour #}
			<a href="{{ path('admin_amendment_index') }}" class="btn-secondary flex items-center gap-2">
				{{ ux_icon('lucide:arrow-left', {class: 'w-4 h-4'}) }}
				Retour
			</a>
		</div>
	</div>

	{# Alerte si avenant annulé avec raison #}
	{% if amendment.statut.value == 'cancelled' %}
		<div class="bg-red-500/20 border border-red-500/30 rounded-xl p-4 scroll-animate">
			<div class="flex items-start gap-3">
				{{ ux_icon('lucide:x-circle', {class: 'w-5 h-5 text-red-400 mt-0.5'}) }}
				<div class="flex-1">
					<p class="text-red-300 font-medium mb-1">Avenant annulé</p>
					<p class="text-red-200/80 text-sm">Cet avenant a été annulé. Voir la section "Informations" pour la raison.</p>
				</div>
			</div>
		</div>
		{# Alerte si avenant signé (immuable) #}
	{% elseif amendment.statut.value == 'signed' %}
		<div class="bg-green-500/20 border border-green-500/30 rounded-xl p-4 scroll-animate">
			<div class="flex items-start gap-3">
				{{ ux_icon('lucide:lock', {class: 'w-5 h-5 text-green-400 mt-0.5'}) }}
				<div class="flex-1">
					<p class="text-green-300 font-medium mb-1">Avenant signé</p>
					<p class="text-green-200/80 text-sm">Cet avenant est signé et ne peut plus être modifié.</p>
				</div>
			</div>
		</div>
	{% endif %}

	{# Informations principales #}
	<div
		class="grid grid-cols-1 lg:grid-cols-3 gap-6">

		{# Colonne principale #}
		<div
			class="lg:col-span-2 space-y-6">

			{# Informations de l'avenant #}
			<div class="bg-white/10 backdrop-blur-xl border border-white/20 rounded-xl p-6 scroll-animate">
				<h2 class="text-xl font-semibold text-white mb-6 flex items-center gap-2">
					{{ ux_icon('lucide:file-edit', {class: 'w-5 h-5'}) }}
					Informations de l'avenant
				</h2>

				<div class="grid grid-cols-1 md:grid-cols-2 gap-6">
					<div>
						<p class="text-sm text-white/60 mb-1">Devis associé</p>
						{% if amendment.quote %}
							<a href="{{ path('admin_quote_show', {id: amendment.quote.id}) }}" class="text-blue-400 hover:text-blue-300 transition-colors">
								{{ amendment.quote.numero }}
							</a>
						{% else %}
							<p class="text-white/60">Aucun devis</p>
						{% endif %}
					</div>

					<div>
						<p class="text-sm text-white/60 mb-1">Statut</p>
						{% set status = amendment.statutEnum %}
						<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium
								                            {% if status.value == 'draft' %}bg-gray-500/20 text-gray-300
								                            {% elseif status.value == 'sent' %}bg-blue-500/20 text-blue-300
								                            {% elseif status.value == 'signed' %}bg-green-500/20 text-green-300
								                            {% elseif status.value == 'cancelled' %}bg-gray-600/20 text-gray-400
								                            {% else %}bg-gray-500/20 text-gray-300{% endif %}">
							{{ status.label }}
						</span>
					</div>

					<div>
						<p class="text-sm text-white/60 mb-1">Date de création</p>
						<p class="text-white">{{ amendment.dateCreation|date('d/m/Y à H:i') }}</p>
					</div>

					{% if amendment.sentAt %}
						<div>
							<p class="text-sm text-white/60 mb-1">Date d'envoi</p>
							<p class="text-white">{{ amendment.sentAt|date('d/m/Y à H:i') }}</p>
							{% if amendment.sentCount > 0 %}
								<p class="text-xs text-white/60">Envoyé
									{{ amendment.sentCount }}
									fois</p>
							{% endif %}
						</div>
					{% endif %}

					{% if amendment.dateSignature %}
						<div>
							<p class="text-sm text-white/60 mb-1">Date de signature</p>
							<p class="text-white">{{ amendment.dateSignature|date('d/m/Y à H:i') }}</p>
						</div>
					{% endif %}

					<div>
						<p class="text-sm text-white/60 mb-1">Motif</p>
						<p class="text-white">{{ amendment.motif }}</p>
					</div>

					{% if companySettings and companySettings.isTvaEnabled() %}
						<div>
							<p class="text-sm text-white/60 mb-1">Taux TVA</p>
							<p class="text-white">{{ amendment.tauxTVA }}%</p>
						</div>
					{% endif %}
				</div>

				{% if amendment.modifications %}
					<div class="mt-6">
						<p class="text-sm text-white/60 mb-2">Description des modifications</p>
						<p class="text-white whitespace-pre-line">{{ amendment.modifications }}</p>
					</div>
				{% endif %}

				{% if amendment.justification %}
					<div class="mt-6">
						<p class="text-sm text-white/60 mb-2">Justification</p>
						<p class="text-white whitespace-pre-line">{{ amendment.justification }}</p>
					</div>
				{% endif %}

				{% if amendment.notes %}
					<div class="mt-6">
						<p class="text-sm text-white/60 mb-2">Notes</p>
						<p class="text-white whitespace-pre-line">{{ amendment.notes }}</p>
					</div>
				{% endif %}

				{% if amendment.quote %}
					<div class="mt-6 pt-6 border-t border-white/20">
						<div class="flex justify-between items-center text-sm mb-2">
							<span class="text-white/60">Total devis final</span>
							<span class="text-white font-semibold">{{ amendment.montantTTC|number_format(2, ',', ' ') }} €</span>
						</div>
						<p class="text-white text-sm mt-2">Cet avenant modifie le montant du devis
							{{ amendment.quote.numero }}</p>
					</div>
				{% endif %}
			</div>

			{# Lignes de l'avenant #}
			<div class="bg-white/10 backdrop-blur-xl border border-white/20 rounded-xl p-6 scroll-animate animate-delay-100">
				<h2 class="text-xl font-semibold text-white mb-6 flex items-center gap-2">
					{{ ux_icon('lucide:list', {class: 'w-5 h-5'}) }}
					Lignes de l'avenant
				</h2>

				{% if amendment.lines|length > 0 %}
					<div class="hidden md:block overflow-x-auto">
						<table class="w-full">
							<thead class="bg-white/5 border-b border-white/20">
								<tr>
									<th class="px-4 py-3 text-left text-xs font-semibold text-white/80 uppercase">Description</th>
									<th class="px-4 py-3 text-right text-xs font-semibold text-white/80 uppercase">Qté</th>
									<th class="px-4 py-3 text-center text-xs font-semibold text-white/80 uppercase">Ajustement / Prix unitaire</th>
									{% if companySettings and companySettings.isTvaEnabled() %}
										<th class="px-4 py-3 text-right text-xs font-semibold text-white/80 uppercase">TVA</th>
									{% endif %}
									<th class="px-4 py-3 text-right text-xs font-semibold text-white/80 uppercase">Ancien montant</th>
									<th class="px-4 py-3 text-right text-xs font-semibold text-white/80 uppercase">Nouveau montant</th>
									<th class="px-4 py-3 text-right text-xs font-semibold text-white/80 uppercase">Total TTC</th>
								</tr>
							</thead>
							<tbody class="divide-y divide-white/10">
								{% for line in amendment.lines %}
									<tr>
										<td class="px-4 py-3 text-white">
											{{ line.description }}
										</td>
										<td class="px-4 py-3 text-right text-white">{{ line.quantity }}</td>
										<td class="px-4 py-3 text-center text-white">
											{% if line.sourceLine %}
												{# Modification : unitPrice = ajustement (delta) #}
												<span class="text-white/60 text-xs">Ajustement:</span><br>
<span class="{% if (line.unitPrice|number_format(2, '.', '')) > 0 %}text-green-400{% elseif (line.unitPrice|number_format(2, '.', '')) < 0 %}text-red-400{% else %}text-white{% endif %}">
													{{ line.unitPrice|number_format(2, ',', ' ') }} €
												</span>
											{% else %}
												{# Nouvelle ligne : unitPrice = prix unitaire réel #}
												{{ line.unitPrice|number_format(2, ',', ' ') }} €
											{% endif %}
										</td>
										{% if companySettings and companySettings.isTvaEnabled() %}
											<td class="px-4 py-3 text-right text-white">
												{{ line.tvaRate ? line.tvaRate ~ '%' : (amendment.tauxTVA ~ '%') }}
											</td>
										{% endif %}
										<td class="px-4 py-3 text-right text-white/60">{{ line.oldValue|number_format(2, ',', ' ') }} €</td>
										<td class="px-4 py-3 text-right text-white font-medium">{{ line.newValue|number_format(2, ',', ' ') }} €</td>
										<td class="px-4 py-3 text-right text-white font-medium">{{ line.totalTtcFormatted }}</td>
									</tr>
								{% endfor %}
							</tbody>
						</table>
					</div>
				{% else %}
					<p class="text-white/60 text-center py-8">Aucune ligne dans cet avenant</p>
				{% endif %}
			</div>
		</div>
		{# Colonne latérale #}
		<div class="space-y-6">
			{# Montants #}
			<div class="bg-white/10 backdrop-blur-xl border border-white/20 rounded-xl p-6 scroll-animate animate-delay-100">
				<h2 class="text-xl font-semibold text-white mb-6 flex items-center gap-2">
					{{ ux_icon('lucide:calculator', {class: 'w-5 h-5'}) }}
					Montants
				</h2>
				<div class="space-y-4">
					{% if companySettings and companySettings.isTvaEnabled() %}
						<div class="flex justify-between">
							<span class="text-white/60">Montant HT</span>
							<span class="text-white font-medium">{{ amendment.montantHTFormate }}</span>
						</div>
						<div class="flex justify-between">
							<span class="text-white/60">TVA</span>
							<span class="text-white font-medium">{{ amendment.montantTVAFormate }}</span>
						</div>
						<div class="flex justify-between pt-4 border-t border-white/20">
							<span class="text-white font-semibold">Total TTC</span>
							<span class="text-white font-bold text-lg">{{ amendment.montantTTCFormate }}</span>
						</div>
					{% else %}
						{# TVA désactivée : afficher TTC au lieu de HT #}
						<div class="flex justify-between pt-4 border-t border-white/20">
							<span class="text-white font-semibold">Total TTC</span>
							<span class="text-white font-bold text-lg">{{ amendment.montantTTCFormate }}</span>
						</div>
					{% endif %}
					{% if amendment.quote %}
						<div class="pt-4 border-t border-white/20">
							<div class="flex justify-between items-center text-sm mb-2">
								<span class="text-white/60">Total devis final</span>
								<span class="text-white font-semibold">{{ amendment.montantTTC|number_format(2, ',', ' ') }} €</span>
							</div>

							<div class="flex justify-between items-center text-sm mb-2 text-blue-300">
								<span class="text-white/60">Dont montant avenant (Différentiel)</span>
								<span class="font-semibold">{{ amendment.getMontantDeltaTtcFormate() }}</span>
							</div>
                            {# Calcul du total payé (règlements effectifs) #}
                            {% set totalPaid = 0 %}
                            {% set quote = amendment.quote %}

                            {# 1. Facture Principale #}
                            {% if quote.invoice and quote.invoice.statut == 'paid' %}
                                {% set totalPaid = quote.montantTTCInitial %}
                            {% else %}
                                {% set totalPaid = quote.totalPaidDeposits %}
                            {% endif %}

                            {# 2. Factures des avenants et remoursements d'avoirs #}
                            {% set avenantsSignes = quote.amendments|filter(a => a.statut.value == 'signed') %}
                            {% for otherAmendment in avenantsSignes %}
                                {# Complément d'avenant payé #}
                                {% if otherAmendment.invoice and otherAmendment.invoice.statut == 'paid' %}
                                    {% set totalPaid = totalPaid + otherAmendment.invoice.montantTTC %}
                                {% endif %}

                                {# Avoir remboursé #}
                                {% if otherAmendment.creditNote and otherAmendment.creditNote.statut == 'refunded' %}
                                    {% set totalPaid = totalPaid - otherAmendment.creditNote.montantTTC %}
                                {% endif %}
                            {% endfor %}

                            {% if totalPaid > 0 %}
                                <div class="flex justify-between items-center mb-2">
                                    <span class="text-white/60">Déjà réglé</span>
                                    <span class="text-green-400 font-semibold">{{ totalPaid|number_format(2, ',', ' ') }} €</span>
                                </div>
                            {% endif %}

							<div class="flex justify-between items-center pt-2 border-t border-white/10 mt-2">
								{% set solde = amendment.montantTTC - totalPaid %}
								<span class="text-white font-medium">
									{% if solde < 0 %}Reste à rembourser{% else %}Reste à payer (Solde){% endif %}
								</span>
								<span class="text-white font-bold text-lg">
									{{ solde|abs|number_format(2, ',', ' ') }} €
								</span>
							</div>
						</div>
					{% endif %}
				</div>
			</div>
			{# Actions #}
            <div class="bg-white/10 backdrop-blur-xl border border-white/20 rounded-xl p-6 scroll-animate animate-delay-200">
				<h2 class="text-xl font-semibold text-white mb-6 flex items-center gap-2">
					{{ ux_icon('lucide:zap', {class: 'w-5 h-5'}) }}
					Actions
				</h2>
				<div class="space-y-3">
					{{ component('EntityActions', {
						entity: amendment,
						type: 'amendment',
						layout: 'vertical'
					}) }}

				</div>
			</div>
			{# Magic Links - Liens signés pour le client #}
			{% if amendment.statut.value in ['sent'] %}
				<div class="scroll-animate animate-delay-300">
					{{ component('MagicLinks', {
						entity: amendment,
						entityType: 'amendment',
						availableActions: ['view', 'sign', 'refuse']
					}) }}
				</div>
			{% endif %}
		</div>
	</div>
</div>
{# Modal d'envoi d'email #}
{{ component('EmailModal') }}
{# Modal d'annulation avec raisons #}
{{ component('CancelModal') }}
{% endblock %}
