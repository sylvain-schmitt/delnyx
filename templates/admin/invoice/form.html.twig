{% extends 'admin/layout/base.html.twig' %}
{% import 'admin/macros/form_fields.html.twig' as form_macros %}

{% block title %}
	{{ title }}
	- Administration Delnyx
{% endblock %}

{% block page_title %}
	{{ title }}
{% endblock %}

{% block body %}
	<div
		class="space-y-6">

		{# Header avec breadcrumb #}
		<div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 scroll-animate">
			<div>
				<h1 class="text-2xl font-bold text-white">{{ title }}</h1>
				<nav class="flex items-center space-x-2 text-sm text-white/60 mt-1">
					<a href="{{ path('admin_dashboard') }}" class="hover:text-white transition-colors duration-200">Dashboard</a>
					<span>{{ ux_icon('lucide:chevron-right', {class: 'w-4 h-4'}) }}</span>
					<a href="{{ path('admin_invoice_index') }}" class="hover:text-white transition-colors duration-200">Factures</a>
					<span>{{ ux_icon('lucide:chevron-right', {class: 'w-4 h-4'}) }}</span>
					<span class="text-white">{{ title }}</span>
				</nav>
			</div>
			<a href="{{ path('admin_invoice_index') }}" class="btn-secondary flex items-center gap-2">
				{{ ux_icon('lucide:arrow-left', {class: 'w-4 h-4'}) }}
				Retour à la liste
			</a>
		</div>

		{# Alerte immutabilité si facture émise #}
		{% if invoice.statutEnum and invoice.statutEnum.isEmitted() %}
			<div class="bg-blue-500/20 border border-blue-500/30 rounded-xl p-4 scroll-animate mb-6">
				<div class="flex items-start gap-3">
					{{ ux_icon('lucide:lock', {class: 'w-5 h-5 text-blue-400 mt-0.5'}) }}
					<div class="flex-1">
						<p class="text-blue-300 font-medium mb-1">Facture émise - Document immuable</p>
						<p class="text-blue-200/80 text-sm">Cette facture est émise et ne peut plus être modifiée. Pour apporter des corrections, créez un avoir.</p>
					</div>
				</div>
			</div>
		{% endif %}

		{# Alerte si facture créée depuis un devis #}
		{% if hasQuote %}
			<div class="bg-amber-500/20 border border-amber-500/30 rounded-xl p-4 scroll-animate mb-6">
				<div class="flex items-start gap-3">
					{{ ux_icon('lucide:file-text', {class: 'w-5 h-5 text-amber-400 mt-0.5'}) }}
					<div class="flex-1">
						<p class="text-amber-300 font-medium mb-1">Facture créée depuis un devis signé</p>
						<p class="text-amber-200/80 text-sm">Les lignes de cette facture proviennent d'un devis signé et ne peuvent pas être modifiées pour des raisons légales. Les montants doivent correspondre exactement au devis.</p>
					</div>
				</div>
			</div>
		{% endif %}

		{# Formulaire #}
		{% set isReadOnly = invoice.statutEnum and invoice.statutEnum.isEmitted() %}
		{% set hasQuote = hasQuote|default(false) %}
		{% set linesReadOnly = hasQuote or isReadOnly or (form.lines.vars.disabled|default(false)) %}
		<div class="bg-white/10 backdrop-blur-xl border border-white/20 rounded-xl p-6 scroll-animate animate-delay-100" data-controller="invoice-form quote-form flash-messages" {% if hasQuote %} data-has-quote="true" {% endif %} {% if companySettings %} data-company-settings data-tva-enabled="{{ companySettings.isTvaEnabled() ? 'true' : 'false' }}" data-use-per-line-tva="{% if invoice.quote %}{{ invoice.quote.usePerLineTva ? 'true' : 'false' }}{% else %}false{% endif %}" {% endif %}>
			{{ form_start(form, {'attr': {'class': 'space-y-6', 'data-controller': 'admin-form', 'data-admin-form-target': 'form', 'novalidate': 'novalidate', 'data-action': 'submit->admin-form#handleSubmit'}}) }}

			{# Messages flash avec contrôleur Stimulus #}
			<div data-flash-messages-target="container" class="space-y-3 mb-4">
				{% for type, messages in app.flashes %}
					{% for message in messages %}
						<div data-flash-messages-target="message" class="glass-card optimized-blur p-4 border-l-4 {% if type == 'success' %}border-emerald-500{% elseif type == 'error' %}border-red-500{% else %}border-blue-500{% endif %}" data-flash-messages-message-param="{{ loop.index }}">
							<div class="flex items-center">
								<div class="w-8 h-8 rounded-lg flex items-center justify-center mr-3 {% if type == 'success' %}bg-emerald-500/20{% else %}bg-red-500/20{% endif %}">
									{% if type == 'success' %}
										{{ ux_icon('lucide:check-circle', {class: 'w-5 h-5 text-emerald-400'}) }}
									{% else %}
										{{ ux_icon('lucide:alert-circle', {class: 'w-5 h-5 text-red-400'}) }}
									{% endif %}
								</div>
								<div class="flex-1">
									<p class="text-white font-medium">{{ message }}</p>
								</div>
							</div>
						</div>
					{% endfor %}
				{% endfor %}
			</div>

			{# Informations générales #}
			<div class="space-y-4">
				<h3 class="text-lg font-semibold text-white flex items-center gap-2">
					{{ ux_icon('lucide:receipt', {class: 'w-5 h-5'}) }}
					Informations générales
				</h3>

				{# Le champ numero est toujours caché (généré automatiquement en création, affiché dans le titre en édition) #}
				{{ form_widget(form.numero, {'attr': {'style': 'display: none'}}) }}

				<div class="grid grid-cols-1 md:grid-cols-2 gap-4">
					<div class="form-group" data-controller="select-search" data-select-search-type="quote">
						{{ form_label(form.quote, null, {'label_attr': {'class': 'form-label'}}) }}
						{% if hasQuote or isReadOnly %}
							{{ form_widget(form.quote, {'attr': {'class': 'form-select', 'data-admin-form-target': 'field', 'disabled': 'disabled'}}) }}
							{% if hasQuote %}
								<p class="text-sm text-white/60 mt-1">Le devis est verrouillé car la facture a été créée depuis ce devis.</p>
							{% endif %}
						{% else %}
							{{ form_widget(form.quote, {'attr': {'class': 'form-select', 'data-admin-form-target': 'field'}}) }}
						{% endif %}
						{# Toujours créer un champ caché si le select a une valeur, pour s'assurer que la valeur est soumise même si le select est désactivé #}
						{% if form.quote.vars.value %}
							{% set quoteValue = form.quote.vars.value %}
							{% set quoteId = attribute(quoteValue, 'id')|default(quoteValue) %}
							<input type="hidden" name="{{ form.quote.vars.full_name }}" value="{{ quoteId }}" id="{{ form.quote.vars.id }}_hidden">
						{% endif %}
						{{ form_help(form.quote) }}
						{{ form_errors(form.quote) }}
					</div>
					<div class="form-group" data-controller="select-search" data-select-search-type="client">
						{{ form_label(form.client, null, {'label_attr': {'class': 'form-label'}}) }}
						{{ form_widget(form.client, {'attr': {'class': 'form-select', 'data-admin-form-target': 'field', 'disabled': isReadOnly ? 'disabled' : false}}) }}
						{{ form_help(form.client) }}
						{{ form_errors(form.client) }}
					</div>
				</div>

				<div class="grid grid-cols-1 md:grid-cols-2 gap-4">
					{{ form_macros.simple_field(form, 'statut', 'select', {'disabled': isReadOnly}) }}
					<div class="form-group" data-controller="date-picker">
						{{ form_label(form.dateEcheance, null, {'label_attr': {'class': 'form-label'}}) }}
						<div class="relative">
							{{ form_widget(form.dateEcheance, {'attr': {'class': 'form-input pr-10', 'data-admin-form-target': 'field', 'data-date-picker-target': 'input', 'disabled': isReadOnly ? 'disabled' : false}}) }}
							{% if not isReadOnly %}
								<button type="button" class="absolute right-3 top-1/2 -translate-y-1/2 text-white/70 hover:text-white transition-colors cursor-pointer focus:outline-none focus:ring-2 focus:ring-blue-500/50 rounded p-1" data-date-picker-target="button" aria-label="Ouvrir le calendrier">
									{{ ux_icon('lucide:calendar', {class: 'w-5 h-5'}) }}
								</button>
							{% endif %}
						</div>
						{{ form_help(form.dateEcheance) }}
						{{ form_errors(form.dateEcheance) }}
					</div>
				</div>
			</div>


			{# Lignes de facture #}
			<div class="space-y-4" data-controller="tva-per-line">
				<div class="flex items-center justify-between">
					<h3 class="text-lg font-semibold text-white flex items-center gap-2">
						{{ ux_icon('lucide:list', {class: 'w-5 h-5'}) }}
						Lignes de facture
					</h3>
					<div class="flex items-center gap-3">
						{% if companySettings and companySettings.isTvaEnabled() and not isReadOnly %}
							<button type="button" class="btn-secondary text-sm py-2 px-4 flex items-center gap-2 {% if hasQuote %}!hidden{% endif %}" data-tva-per-line-target="toggle" data-invoice-form-target="tvaPerLineButton" data-action="click->tva-per-line#toggle" data-label-disabled="Appliquer la TVA par ligne" data-label-enabled="Désactiver la TVA par ligne" {% if hasQuote %} style="display: none;" {% endif %}>
								{{ ux_icon('lucide:percent', {class: 'w-4 h-4'}) }}
								<span>Appliquer la TVA par ligne</span>
							</button>
						{% endif %}
						{% if hasQuote %}
							<div class="bg-blue-500/20 border border-blue-500/30 rounded-lg px-3 py-2">
								<p class="text-blue-300 text-sm flex items-center gap-2">
									{{ ux_icon('lucide:lock', {class: 'w-4 h-4'}) }}
									Lignes du devis (lecture seule)
								</p>
							</div>
						{% elseif not isReadOnly %}
							<button type="button" class="btn-secondary text-sm py-2 px-4" data-action="click->quote-form#addLine" data-invoice-form-target="addLineButton" {% if hasQuote %} style="display: none;" {% endif %}>
								{{ ux_icon('lucide:plus', {class: 'w-4 h-4'}) }}
								Ajouter une ligne
							</button>
						{% endif %}
					</div>
				</div>

				{% if hasQuote and invoice.lines|length > 0 %}
					{# Affichage en tableau pour les lignes du devis #}
					<div class="bg-white/5 border border-white/10 rounded-lg overflow-hidden">
						<div class="overflow-x-auto">
							<table class="w-full">
								<thead class="bg-white/10 border-b border-white/20">
									<tr>
										<th class="px-4 py-3 text-left text-xs font-semibold text-white/80 uppercase tracking-wider">Description</th>
										<th class="px-4 py-3 text-right text-xs font-semibold text-white/80 uppercase tracking-wider">Quantité</th>
										<th class="px-4 py-3 text-right text-xs font-semibold text-white/80 uppercase tracking-wider">Prix unitaire HT</th>
										{% if companySettings and companySettings.isTvaEnabled() and invoice.quote and invoice.quote.usePerLineTva %}
											<th class="px-4 py-3 text-right text-xs font-semibold text-white/80 uppercase tracking-wider">TVA</th>
										{% endif %}
										<th class="px-4 py-3 text-right text-xs font-semibold text-white/80 uppercase tracking-wider">Total HT</th>
										<th class="px-4 py-3 text-right text-xs font-semibold text-white/80 uppercase tracking-wider">Total TTC</th>
									</tr>
								</thead>
								<tbody class="divide-y divide-white/10">
									{% for line in invoice.lines %}
										<tr class="hover:bg-white/5 transition-colors">
											<td class="px-4 py-3 text-sm text-white/90">
												<div class="font-medium">{{ line.description|default('N/A') }}</div>
												{% if line.tariff %}
													<div class="text-xs text-white/60 mt-1">{{ line.tariff.name }}</div>
												{% endif %}
											</td>
											<td class="px-4 py-3 text-sm text-white/90 text-right">{{ line.quantity|default(0) }}</td>
											<td class="px-4 py-3 text-sm text-white/90 text-right">{{ line.unitPrice|number_format(2, ',', ' ') }}
												€</td>
											{% if companySettings and companySettings.isTvaEnabled() and invoice.quote and invoice.quote.usePerLineTva %}
												<td class="px-4 py-3 text-sm text-white/90 text-right">{{ line.tvaRate|default(0) }}%</td>
											{% endif %}
											<td class="px-4 py-3 text-sm text-white/90 text-right font-medium">{{ line.totalHt|number_format(2, ',', ' ') }}
												€</td>
											<td class="px-4 py-3 text-sm text-white/90 text-right font-semibold">{{ line.getTotalTtc()|number_format(2, ',', ' ') }}
												€</td>
										</tr>
									{% endfor %}
								</tbody>
							</table>
						</div>
					</div>
					{# Champs cachés pour la soumission du formulaire #}
					<div style="display: none;">
						{% for line in form.lines %}
							{{ form_widget(line) }}
						{% endfor %}
					</div>
				{% else %}
					{# Affichage normal avec formulaire pour les lignes modifiables #}
					<div data-quote-form-target="linesContainer" class="space-y-4" data-admin-form-target="linesContainer">
						{% for line in form.lines %}
							<div class="bg-white/5 border border-white/10 rounded-lg p-4 {% if not line.vars.valid %}border-red-500/50{% endif %}" data-line-index="{{ loop.index0 }}">
								{% if not line.vars.valid %}
									<div class="mb-4 p-3 bg-red-500/20 border border-red-500/30 rounded-lg">
										<p class="text-red-300 text-sm font-medium mb-2">Erreurs dans cette ligne :</p>
										{{ form_errors(line) }}
										{% for child in line.children %}
											{% if not child.vars.valid %}
												<div class="mt-1 text-sm">
													<strong class="text-red-300">{{ form_label(child) }}
														:</strong>
													{{ form_errors(child) }}
												</div>
											{% endif %}
										{% endfor %}
									</div>
								{% endif %}
								<div class="grid grid-cols-1 md:grid-cols-2 gap-4">
									{{ form_macros.simple_field(line, 'tariff', 'select', {'disabled': linesReadOnly}) }}
									{{ form_macros.simple_field(line, 'description', 'text', {'disabled': linesReadOnly}) }}
								</div>
								<div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
									{{ form_macros.simple_field(line, 'quantity', 'number', {'disabled': linesReadOnly}) }}
									{{ form_macros.simple_field(line, 'unitPrice', 'number', {'disabled': linesReadOnly}) }}
									{% if companySettings and companySettings.isTvaEnabled() %}
										{# Afficher le champ TVA si TVA est activée dans companySettings #}
										{# Si un devis est associé, vérifier aussi usePerLineTva #}
											{% if invoice.quote and not invoice.quote.usePerLineTva %}
											{# TVA globale : cacher le champ mais le garder pour la soumission #}
												<div style="display: none;"> {{ form_widget(line.tvaRate) }}
											</div>
										{% else %}
											{# TVA par ligne : afficher le champ (masqué par défaut, visible si bouton activé) #}
											<div data-tva-per-line-target="rateWrapper" style="display: none;">
												{{ form_macros.simple_field(line, 'tvaRate', 'select', {'disabled': linesReadOnly}) }}
											</div>
										{% endif %}
									{% else %}
										{# Cacher le champ tvaRate si TVA désactivée #}
										<div style="display: none;">
											{{ form_widget(line.tvaRate) }}
										</div>
									{% endif %}
								</div>
								{% if not linesReadOnly %}
									<div class="flex items-center justify-end mt-4 pt-4 border-t border-white/10">
										<button type="button" class="text-red-400 hover:text-red-300 text-sm flex items-center gap-1" data-action="click->quote-form#removeLine">
											{{ ux_icon('lucide:trash-2', {class: 'w-4 h-4'}) }}
											Supprimer
										</button>
									</div>
								{% endif %}
							</div>
						{% endfor %}
					</div>
				{% endif %}

				{# Template pour nouvelle ligne (caché) #}
				<template data-quote-form-target="lineTemplate">
					<div class="bg-white/5 border border-white/10 rounded-lg p-4" data-line-index="__name__">
						<div class="grid grid-cols-1 md:grid-cols-2 gap-4">
							<div class="form-group">
								<label class="form-label">Tarif du catalogue</label>
								<select name="invoice[lines][__name__][tariff]" class="form-select" data-admin-form-target="field">
									<option value="">Aucun (ligne personnalisée)</option>
									{% for tariff in tariffs|default([]) %}
										<option value="{{ tariff.id }}">{{ tariff.nom }} - {{ tariff.prix|number_format(2, ',', ' ') }} € ({{ tariff.uniteLabel }})</option>
									{% endfor %}
								</select>
							</div>
							<div class="form-group">
								<label class="form-label">Description</label>
								<input type="text" name="invoice[lines][__name__][description]" class="form-input" data-admin-form-target="field" required>
							</div>
						</div>
						<div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
							<div class="form-group">
								<label class="form-label">Quantité</label>
								<input type="number" name="invoice[lines][__name__][quantity]" class="form-input" data-admin-form-target="field" min="1" value="1" required>
							</div>
							<div class="form-group">
								<label class="form-label">Prix unitaire (€)</label>
								<input type="number" name="invoice[lines][__name__][unitPrice]" class="form-input" data-admin-form-target="field" step="0.01" min="0" required>
							</div>
							{% if companySettings and companySettings.isTvaEnabled() %}
								<div class="form-group" data-tva-per-line-target="rateWrapper" style="display: none;">
									<label class="form-label">Taux TVA (%)</label>
									<select name="invoice[lines][__name__][tvaRate]" class="form-select" data-admin-form-target="field">
										<option value="">Taux global</option>
										<option value="0.00">0%</option>
										<option value="5.50">5,5%</option>
										<option value="10.00">10%</option>
										<option value="20.00">20%</option>
									</select>
								</div>
							{% else %}
								<div class="form-group" style="display: none;">
									<label class="form-label">Taux TVA (%)</label>
									<select name="invoice[lines][__name__][tvaRate]" class="form-select" data-admin-form-target="field">
										<option value="">Taux global</option>
									</select>
								</div>
							{% endif %}
						</div>
						<div class="flex items-center justify-end mt-4 pt-4 border-t border-white/10">
							<button type="button" class="text-red-400 hover:text-red-300 text-sm flex items-center gap-1" data-action="click->quote-form#removeLine">
								{{ ux_icon('lucide:trash-2', {class: 'w-4 h-4'}) }}
								Supprimer
							</button>
						</div>
					</div>
				</template>
			</div>

			{# Montants et conditions #}
			<div class="space-y-4">
				<h3 class="text-lg font-semibold text-white flex items-center gap-2">
					{{ ux_icon('lucide:euro', {class: 'w-5 h-5'}) }}
					Montants et conditions
				</h3>

				<div class="grid grid-cols-1 md:grid-cols-2 gap-4">
					{{ form_macros.simple_field(form, 'montantAcompte') }}
					{{ form_macros.simple_field(form, 'delaiPaiement') }}
				</div>

				{{ form_macros.simple_field(form, 'conditionsPaiement', 'textarea') }}
				{{ form_macros.simple_field(form, 'penalitesRetard') }}
			</div>

			{# Notes #}
			<div class="space-y-4">
				<h3 class="text-lg font-semibold text-white flex items-center gap-2">
					{{ ux_icon('lucide:sticky-note', {class: 'w-5 h-5'}) }}
					Notes
				</h3>

				{{ form_macros.simple_field(form, 'notes', 'textarea') }}
			</div>

			{# Actions #}
			<div class="flex flex-col sm:flex-row gap-3 pt-6 border-t border-white/20">
				<button type="submit" class="btn-primary flex items-center justify-center gap-2" data-admin-form-target="submit">
					{{ ux_icon('lucide:save', {class: 'w-4 h-4'}) }}
					{{ invoice.id ? 'Modifier la facture' : 'Créer la facture' }}
				</button>

				<a href="{{ path('admin_invoice_index') }}" class="btn-secondary flex items-center justify-center gap-2">
					{{ ux_icon('lucide:x', {class: 'w-4 h-4'}) }}
					Annuler
				</a>
			</div>

			{# Rendre les champs restants non rendus (comme numero en création) #}
			{{ form_rest(form) }}

			{{ form_end(form, {'render_rest': false}) }}
		</div>
	</div>
{% endblock %}
