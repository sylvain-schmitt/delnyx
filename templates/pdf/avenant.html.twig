{% extends 'pdf/base.html.twig' %}

{% block content %}
	<!-- En-tête -->
	{% if amendment.statut.value == 'signed' %}
		<div class="watermark watermark-signed">SIGNÉ</div>
	{% endif %}
	<div class="header">
		<div class="company-info">
			<div class="company-logo">
				{% if logo_base64 %}
					<img src="{{ logo_base64 }}" alt="{{ company.raisonSociale ?? 'Logo' }}" style="height: 40px; width: auto;">
				{% else %}
					<span style="font-size: 24px; font-weight: bold; color: #2563eb; letter-spacing: 2px;">{{ company.raisonSociale ?? 'ENTREPRISE' }}</span>
				{% endif %}
			</div>
			<div class="company-details">
				{% if company %}
					<strong>{{ company.raisonSociale }}</strong><br>
					{{ company.formeJuridique ?? 'Micro-entrepreneur' }}
					{% if company.codeAPE %}
						• APE:
						{{ company.codeAPE }}
					{% endif %}<br>
					{{ company.adresse }}<br>
					{{ company.codePostal }}
					{{ company.ville }}<br>
					{% if company.siret %}SIRET:
						{{ company.siret }}<br>
					{% endif %}
					{% if company.email %}Email:
						{{ company.email }}<br>
					{% endif %}
					{% if company.telephone %}Tél:
						{{ company.telephone }}
					{% endif %}
				{% else %}
					<strong>Entreprise</strong><br>
					Informations non disponibles
				{% endif %}
			</div>
		</div>
		<div class="document-info">
			<div class="document-title">AVENANT</div>
			<div class="document-number">{{ amendment.numero ?? ('AV-' ~ amendment.id) }}</div>
			<div class="document-date">
				Date:
				{{ amendment.dateCreation|date('d/m/Y') }}
			</div>
		</div>
	</div>

	<!-- Informations client et devis -->
	<div class="client-section">
		<div class="client-info">
			<div class="section-title">Client</div>
			{% if client.companyName %}
				<div class="client-name">{{ client.companyName }}</div>
				<div class="client-details">
					<strong>{{ client.prenom }}
						{{ client.nom }}</strong><br>
				{% else %}
					<div class="client-name">{{ client.prenom }}
						{{ client.nom }}</div>
					<div class="client-details">
					{% endif %}
					{% if client.email %}
						{{ client.email }}<br>
					{% endif %}
					{% if client.telephone %}
						{{ client.telephone }}<br>
					{% endif %}
					{% if client.adresse %}
						{{ client.adresse }}<br>
						{{ client.codePostal }}
						{{ client.ville }}
					{% endif %}
					{% if client.siret %}<br>SIRET:
						{{ client.siret }}
					{% endif %}
				</div>
			</div>
			{% if quote %}
				<div class="company-billing">
					<div class="section-title">Devis de référence</div>
					<div class="client-details">
						<strong>{{ quote.numero }}</strong><br>
						Signé le
						{{ quote.dateSignature|date('d/m/Y') }}
					</div>
				</div>
			{% endif %}
		</div>

		<!-- Motif et modifications -->
		<div class="conditions-section no-break">
			<div class="conditions-title">Motif de l'avenant</div>
			<div class="conditions-content">
				{{ amendment.motif|nl2br }}
			</div>
		</div>

		<div class="conditions-section no-break">
			<div class="conditions-title">Modifications apportées</div>
			<div class="conditions-content">
				{{ amendment.modifications|nl2br }}
			</div>
		</div>

		<!-- Tableau des lignes modifiées -->
		{% if amendment.lines|length > 0 %}
			<table class="services-table">
				<thead>
					<tr>
						<th style="width: 40%;">Description</th>
						<th style="width: 10%;" class="text-center">Qté</th>
						<th style="width: 15%;" class="text-right">Prix unit.</th>
						{% if company and company.isTvaEnabled() %}
							<th style="width: 10%;" class="text-right">TVA</th>
						{% endif %}
						<th style="width: 15%;" class="text-right">Ancien total</th>
						<th style="width: 15%;" class="text-right">Nouveau total</th>
					</tr>
				</thead>
				<tbody>
					{% for line in amendment.lines %}
						<tr>
							<td>
								<strong>{{ line.description }}</strong>
							</td>
							<td class="text-center">{{ line.quantity }}</td>
							<td class="text-right">{{ line.unitPrice|number_format(2, ',', ' ') }}
								€</td>
							{% if company and company.isTvaEnabled() %}
								<td class="text-right">{{ line.tvaRate }}
									%</td>
							{% endif %}
							<td class="text-right">{{ line.oldValue|number_format(2, ',', ' ') }}
								€</td>
							<td class="text-right">{{ line.newValue|number_format(2, ',', ' ') }}
								€</td>
						</tr>
					{% endfor %}
				</tbody>
			</table>
		{% endif %}

		<!-- Totaux -->
		<div class="totals no-break">
			<table class="totals-table">
				<tr>
					<td class="label">Total HT (nouveaux montants):</td>
					<td class="amount">{{ amendment.montantHTFormate }}</td>
				</tr>
				{% if company and company.isTvaEnabled() and amendment.montantTVA > 0 %}
					<tr>
						<td class="label">Total TVA:</td>
						<td class="amount">{{ amendment.montantTVAFormatted ?? (amendment.montantTVA|number_format(2, ',', ' ') ~ ' €') }}</td>
					</tr>
				{% endif %}
				<tr class="total-row">
					<td class="label">Total TTC (Nouveau):</td>
					<td class="amount">{{ amendment.montantTTCFormate }}</td>
				</tr>

				<!-- Montant spécifique de l'avenant (Delta) -->
				<tr style="background-color: #f0f9ff;">
					<td class="label" style="color: #1e40af;">
						<strong>Dont montant de l'avenant (Différentiel):</strong>
					</td>
					<td class="amount" style="color: #1e40af;">
						<strong>{{ amendment.getMontantDeltaTtcFormate() }}</strong>
					</td>
				</tr>

				<!-- Calcul du total payé (règlements effectifs) -->
				{% set totalPaid = 0 %}
				{% set quote = amendment.quote %}

				{# 1. Facture Principale #}
				{% if quote.invoice and quote.invoice.statut == 'paid' %}
					{% set totalPaid = quote.getMontantTTCInitial() %}
				{% else %}
					{% set totalPaid = quote.totalPaidDeposits %}
				{% endif %}

				{# 2. Factures des avenants et remoursements d'avoirs #}
				{% set avenantsSignes = quote.amendments|filter(a => a.statut.value == 'signed') %}
				{% for otherAmendment in avenantsSignes %}
					{# Complément d'avenant payé #}
					{% if otherAmendment.invoice and otherAmendment.invoice.statut == 'paid' %}
						{% set totalPaid = totalPaid + otherAmendment.invoice.montantTTC %}
					{% endif %}

					{# Avoir remboursé #}
					{% if otherAmendment.creditNote and otherAmendment.creditNote.statut == 'refunded' %}
						{% set totalPaid = totalPaid - otherAmendment.creditNote.montantTTC %}
					{% endif %}
				{% endfor %}

				{% if totalPaid > 0 %}
					<tr>
						<td class="label">Déjà réglé:</td>
						<td class="amount">{{ totalPaid|number_format(2, ',', ' ') }}
							€</td>
					</tr>
					<tr class="total-row">
						{% set solde = amendment.montantTTC - totalPaid %}
						<td class="label">
							{% if solde < 0 %}Reste à rembourser:{% else %}Reste à payer (Solde total):
							{% endif %}
						</td>
						<td class="amount">{{ solde|abs|number_format(2, ',', ' ') }}
							€</td>
					</tr>
				{% endif %}
			</table>
		</div>

		{% if amendment.notes %}
			<div class="notes-section no-break">
				<strong>Notes:</strong><br>
				{{ amendment.notes|nl2br }}
			</div>
		{% endif %}

		<!-- Mentions légales -->
		<div class="legal-mentions no-break">
			<strong>Mentions légales:</strong><br>
			Avenant au devis
			{{ quote.numero }}
			émis le
			{{ amendment.dateCreation|date('d/m/Y') }}.<br>
			{% if company %}
				{{ company.raisonSociale }}
				-
				{{ company.formeJuridique ?? 'Micro-entrepreneur' }}
				{% if company.codeAPE %}
					(APE:
					{{ company.codeAPE }})
				{% endif %}
				{% if company.siret %}
					- SIRET:
					{{ company.siret }}
				{% endif %}<br>
				{% if company.assuranceRCPro %}
					RC Pro:
					{{ company.assuranceRCPro }}<br>
				{% endif %}
			{% endif %}
			<strong>Pénalités de retard:</strong>
			À défaut de paiement, pénalité de 10,00% par an ou 3 fois le taux d'intérêt légal.<br>
			<strong>Escompte:</strong>
			Pas d'escompte pour paiement anticipé.<br>
			{% if company and not company.isTvaEnabled() %}
				<strong>Micro-entrepreneur:</strong>
				TVA non applicable selon l'article 293 B du Code Général des Impôts.
			{% endif %}
		</div>

		<!-- Pied de page -->
		<div class="footer no-break">
			{% if company %}
				<strong>{{ company.raisonSociale }}</strong>
				{% if company.email or company.telephone %}
					|
					{% if company.email %}
						{{ company.email }}
					{% endif %}
					{% if company.email and company.telephone %}
						|
					{% endif %}
					{% if company.telephone %}
						{{ company.telephone }}
					{% endif %}
				{% endif %}
			{% endif %}
		</div>
	{% endblock %}
