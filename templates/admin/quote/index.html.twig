{% extends 'admin/layout/base.html.twig' %}
{% import 'admin/macros/pagination.html.twig' as pagination_macro %}

{% block title %}Devis - Administration Delnyx
{% endblock %}

{% block page_title %}Devis
{% endblock %}

{% block body %}
	<div
		class="space-y-6">

	{# Header avec actions #}
	<div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 scroll-animate">
		<div>
			<h1 class="text-2xl font-bold text-white">Devis</h1>
			<p class="text-white/60 mt-1">{{ total_quotes }}
				devis au total
				{% if not include_cancelled %}
					(hors annulés)
				{% endif %}
			</p>
		</div>
		<div class="flex flex-col sm:flex-row gap-2 sm:gap-3 w-full sm:w-auto">
			{# Bouton principal en pleine largeur sur mobile #}
			<a href="{{ path('admin_quote_new') }}" class="btn-primary flex items-center justify-center gap-2 order-first sm:order-last">
				{{ ux_icon('lucide:file-plus', {class: 'w-4 h-4'}) }}
				<span class="sm:inline">Nouveau Devis</span>
			</a>
			
			{# Boutons secondaires en ligne sur mobile #}
			<div class="flex gap-2">
				{% if include_cancelled %}
					<a href="{{ path('admin_quote_index') }}" class="btn-secondary flex items-center justify-center gap-2 flex-1 sm:flex-initial" title="Masquer les annulés">
						{{ ux_icon('lucide:eye-off', {class: 'w-4 h-4'}) }}
						<span class="hidden lg:inline">Masquer les annulés</span>
					</a>
				{% else %}
					<a href="{{ path('admin_quote_index', {include_cancelled: true}) }}" class="btn-secondary flex items-center justify-center gap-2 flex-1 sm:flex-initial" title="Afficher les annulés">
						{{ ux_icon('lucide:eye', {class: 'w-4 h-4'}) }}
						<span class="hidden lg:inline">Afficher les annulés</span>
					</a>
				{% endif %}
				<a href="{{ path('admin_amendment_index') }}" class="btn-secondary flex items-center justify-center gap-2 flex-1 sm:flex-initial" title="Voir les avenants">
					{{ ux_icon('lucide:file-edit', {class: 'w-4 h-4'}) }}
					<span class="hidden lg:inline">Voir les avenants</span>
				</a>
			</div>
		</div>
	</div>

		{# Liste des devis #}
		{% if quotes|length > 0 %}
			{# Version desktop : table #}
			<div class="hidden md:block bg-white/10 backdrop-blur-xl border border-white/20 rounded-xl overflow-hidden scroll-animate animate-delay-100">
				<div class="overflow-x-auto">
					<table class="w-full">
						<thead class="bg-white/5 border-b border-white/20">
							<tr>
								<th class="px-6 py-4 text-left text-xs font-semibold text-white/80 uppercase tracking-wider">Numéro</th>
								<th class="px-6 py-4 text-left text-xs font-semibold text-white/80 uppercase tracking-wider">Client</th>
								<th class="px-6 py-4 text-left text-xs font-semibold text-white/80 uppercase tracking-wider">Date</th>
								<th class="px-6 py-4 text-left text-xs font-semibold text-white/80 uppercase tracking-wider">Montant TTC</th>
								<th class="px-6 py-4 text-left text-xs font-semibold text-white/80 uppercase tracking-wider">Statut</th>
								<th class="px-6 py-4 text-right text-xs font-semibold text-white/80 uppercase tracking-wider">Actions</th>
							</tr>
						</thead>
						<tbody class="divide-y divide-white/10">
							{% for quote in quotes %}
								<tr class="hover:bg-white/5 transition-colors duration-200">
									<td class="px-6 py-4 whitespace-nowrap">
										<div class="text-sm font-medium text-white">{{ quote.numero ?? 'N/A' }}</div>
									</td>
									<td class="px-6 py-4">
										{% if quote.client.companyName %}
											<div class="text-sm text-white">{{ quote.client.companyName }}</div>
											<div class="text-xs text-white/80">{{ quote.client.prenom }} {{ quote.client.nom }}</div>
										{% else %}
											<div class="text-sm text-white">{{ quote.client.prenom }} {{ quote.client.nom }}</div>
										{% endif %}
										<div class="text-xs text-white/60">{{ quote.client.email }}</div>
									</td>
									<td class="px-6 py-4 whitespace-nowrap">
										<div class="text-sm text-white">{{ quote.dateCreation|date('d/m/Y') }}</div>
										{% if quote.dateValidite %}
											<div class="text-xs text-white/60">Valide jusqu'au
												{{ quote.dateValidite|date('d/m/Y') }}</div>
										{% endif %}
									</td>
									<td class="px-6 py-4 whitespace-nowrap">
										<div class="text-sm font-medium text-white">{{ quote.montantTTCFormate }}</div>
									</td>
									<td class="px-6 py-4 whitespace-nowrap">
										{% set status = quote.statut %}
										<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium
																																																																								                                        {% if status.value == 'draft' %}bg-gray-500/20 text-gray-300
																																																																								                                        {% elseif status.value == 'sent' %}bg-blue-500/20 text-blue-300
																																																																								                                        {% elseif status.value == 'signed' %}bg-green-500/20 text-green-300
																																																																								                                        {% elseif status.value == 'accepted' %}bg-green-500/20 text-green-300
																																																																								                                        {% elseif status.value == 'refused' %}bg-red-500/20 text-red-300
																																																																								                                        {% elseif status.value == 'expired' %}bg-yellow-500/20 text-yellow-300
																																																																								                                        {% elseif status.value == 'cancelled' %}bg-gray-600/20 text-gray-400
																																																																								                                        {% else %}bg-gray-500/20 text-gray-300{% endif %}">
											{{ status.label }}
										</span>
									</td>
									<td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
										<div
											class="flex items-center justify-end gap-2">
											{# Indicateur d'avenants #}
											{% set amendmentsCount = quote.amendments|length %}
											{% if amendmentsCount > 0 %}
												<a href="{{ path('admin_amendment_index', {quote_id: quote.id}) }}" class="inline-flex items-center gap-1 px-2 py-1 rounded-full text-xs font-medium bg-blue-500/20 text-blue-300 hover:bg-blue-500/30 transition-colors duration-200" title="{{ amendmentsCount }} avenant{{ amendmentsCount > 1 ? 's' : '' }}">
													{{ ux_icon('lucide:file-edit', {class: 'w-3 h-3'}) }}
													<span>{{ amendmentsCount }}</span>
												</a>
											{% endif %}

											{# Composant Actions #}
											{{ component('EntityActions', { 
                                            entity: quote, 
                                            type: 'quote',
                                            layout: 'inline'
                                        }) }}

											{# Bouton Créer un avenant : visible si SIGNED #}
											{% if quote.statut.value == 'signed' %}
												<a href="{{ path('admin_amendment_new', {quote_id: quote.id}) }}" class="text-purple-400 hover:text-purple-300 transition-colors duration-200" title="Créer un avenant">
													{{ ux_icon('lucide:file-edit', {class: 'w-4 h-4'}) }}
												</a>
											{% endif %}

											{# Bouton Générer facture : visible si SIGNED et pas de facture existante #}
											{% if quote.statut.value == 'signed' and not quote.invoice %}
												<form action="{{ path('admin_quote_generate_invoice', {id: quote.id}) }}" method="POST" class="inline" data-action="submit->confirm-modal#open" data-confirm-modal-message="Générer une facture depuis ce devis signé ?" data-confirm-modal-title="Confirmer la génération" data-confirm-modal-button="Générer">
													<input type="hidden" name="_token" value="{{ csrf_token('quote_generate_invoice_' ~ quote.id) }}">
													<button type="submit" class="text-green-400 hover:text-green-300 transition-colors duration-200" title="Générer facture">
														{{ ux_icon('lucide:receipt', {class: 'w-4 h-4'}) }}
													</button>
												</form>
											{% endif %}
										</div>
									</td>
								</tr>
							{% endfor %}
						</tbody>
					</table>
				</div>
			</div>

			{# Version mobile : cards #}
			<div class="block md:hidden space-y-4 scroll-animate animate-delay-100">
				{% for quote in quotes %}
					<div class="bg-white/10 backdrop-blur-xl border border-white/20 rounded-xl p-4">
						<div class="flex items-start justify-between mb-3">
							<div class="flex-1">
								<div class="text-sm font-medium text-white mb-1">{{ quote.numero ?? 'N/A' }}</div>
								{% if quote.client.companyName %}
									<div class="text-sm text-white">{{ quote.client.companyName }}</div>
									<div class="text-xs text-white/80">{{ quote.client.prenom }} {{ quote.client.nom }}</div>
								{% else %}
									<div class="text-sm text-white">{{ quote.client.prenom }} {{ quote.client.nom }}</div>
								{% endif %}
								<div class="text-xs text-white/60">{{ quote.client.email }}</div>
							</div>
							<div
								class="flex items-center gap-2 ml-4 flex-wrap">
								{# Indicateur d'avenants #}
								{% set amendmentsCount = quote.amendments|length %}
								{% if amendmentsCount > 0 %}
									<a href="{{ path('admin_amendment_index', {quote_id: quote.id}) }}" class="inline-flex items-center gap-1 px-2 py-1 rounded-full text-xs font-medium bg-blue-500/20 text-blue-300 hover:bg-blue-500/30 transition-colors duration-200" title="{{ amendmentsCount }} avenant{{ amendmentsCount > 1 ? 's' : '' }}">
										{{ ux_icon('lucide:file-edit', {class: 'w-3 h-3'}) }}
										<span>{{ amendmentsCount }}</span>
									</a>
								{% endif %}
							</div>
						</div>

						<div class="space-y-2 text-sm mb-3">
							<div class="flex justify-between">
								<span class="text-white/60">Date</span>
								<span class="text-white">{{ quote.dateCreation|date('d/m/Y') }}</span>
							</div>
							{% if quote.dateValidite %}
								<div class="flex justify-between">
									<span class="text-white/60">Valide jusqu'au</span>
									<span class="text-white">{{ quote.dateValidite|date('d/m/Y') }}</span>
								</div>
							{% endif %}
							<div class="flex justify-between">
								<span class="text-white/60">Montant TTC</span>
								<span class="text-white font-medium">{{ quote.montantTTCFormate }}</span>
							</div>
							<div class="flex justify-between items-center">
								<span class="text-white/60">Statut</span>
								{% set status = quote.statut %}
								<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium
																																																												                                {% if status.value == 'draft' %}bg-gray-500/20 text-gray-300
																																																												                                {% elseif status.value == 'sent' %}bg-blue-500/20 text-blue-300
																																																												                                {% elseif status.value == 'signed' %}bg-green-500/20 text-green-300
																																																												                                {% elseif status.value == 'accepted' %}bg-green-500/20 text-green-300
																																																												                                {% elseif status.value == 'refused' %}bg-red-500/20 text-red-300
																																																												                                {% elseif status.value == 'expired' %}bg-yellow-500/20 text-yellow-300
																																																												                                {% elseif status.value == 'cancelled' %}bg-gray-600/20 text-gray-400
																																																												                                {% else %}bg-gray-500/20 text-gray-300{% endif %}">
									{{ status.label }}
								</span>
							</div>
						</div>

						<div class="pt-3 border-t border-white/10 space-y-2">
							{# Bouton Créer un avenant : visible si SIGNED #}
							{% if quote.statut.value == 'signed' %}
								<a href="{{ path('admin_amendment_new', {quote_id: quote.id}) }}" class="w-full btn-secondary flex items-center justify-center gap-2">
									{{ ux_icon('lucide:file-edit', {class: 'w-4 h-4'}) }}
									Créer un avenant
								</a>
							{% endif %}

							{# Bouton Générer facture : visible si SIGNED et pas de facture existante #}
							{% if quote.statut.value == 'signed' and not quote.invoice %}
								<form action="{{ path('admin_quote_generate_invoice', {id: quote.id}) }}" method="POST" class="w-full" data-action="submit->confirm-modal#open" data-confirm-modal-message="Générer une facture depuis ce devis signé ?" data-confirm-modal-title="Confirmer la génération" data-confirm-modal-button="Générer">
									<input type="hidden" name="_token" value="{{ csrf_token('quote_generate_invoice_' ~ quote.id) }}">
									<button type="submit" class="w-full btn-success flex items-center justify-center gap-2">
										{{ ux_icon('lucide:receipt', {class: 'w-4 h-4'}) }}
										Générer une facture
									</button>
								</form>
							{% endif %}

							{{ component('EntityActions', { 
                            entity: quote, 
                            type: 'quote',
                            layout: 'mobile'
                        }) }}
						</div>
					</div>
				{% endfor %}
			</div>

			{# Pagination #}
			{{ pagination_macro.render(current_page, total_pages, 'admin_quote_index', include_cancelled ? {include_cancelled: true} : {}, 15, total_quotes) }}
		{% else %}
			{# État vide #}
			<div class="text-center py-20 scroll-animate">
				<div class="bg-white/10 backdrop-blur-xl border border-white/20 rounded-xl p-12 max-w-md mx-auto">
					{{ ux_icon('lucide:file-text', {class: 'w-16 h-16 text-gray-400 mb-6 mx-auto'}) }}
					<h3 class="text-2xl font-bold text-white mb-4">Aucun devis</h3>
					<p class="text-gray-300 mb-6">
						Commencez par créer votre premier devis.
					</p>
					<a href="{{ path('admin_quote_new') }}" class="btn-primary">
						{{ ux_icon('lucide:file-plus', {class: 'w-4 h-4 mr-2'}) }}
						Créer un devis
					</a>
				</div>
			</div>
		{% endif %}
	</div>
	
	{# Modal d'envoi d'email #}
	{{ component('EmailModal') }}
	
	{# Modal d'annulation #}
	{{ component('CancelModal') }}
{% endblock %}
