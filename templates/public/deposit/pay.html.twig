{% extends 'public/layout/base.html.twig' %}

{% block title %}Payer l'accompte - Devis
	{{ quote.numero }}
	- Delnyx
{% endblock %}

{% block body %}
	<div class="max-w-2xl mx-auto">
		<div class="bg-white/10 backdrop-blur-xl border border-white/20 rounded-xl p-8">
			<h1 class="text-2xl font-bold text-white mb-6">Paiement de l'acompte</h1>

			<div class="mb-6">
				<p class="text-white/80 mb-2">
					<span class="font-medium text-white">Devis :</span>
					{{ quote.numero }}
				</p>
				<p class="text-white/80 mb-2">
					<span class="font-medium text-white">Client :</span>
					{{ quote.client.nomComplet }}
				</p>

				<div class="mt-4 p-4 bg-white/5 rounded-lg border border-white/10">
					<p class="text-white/80 mb-1">
						<span class="font-medium text-white">Acompte demandé :</span>
						{{ deposit.percentage|number_format(0) }}%
					</p>
					<p class="text-3xl font-bold text-white mt-2">
						{{ deposit.formattedAmount }}
					</p>
					<p class="text-sm text-white/60">Montant à régler maintenant pour valider le devis</p>
				</div>
			</div>

			{% for message in app.flashes('error') %}
				<div class="bg-red-500/20 border border-red-500/30 rounded-lg p-4 mb-6">
					<p class="text-red-300 text-sm">{{ message }}</p>
				</div>
			{% endfor %}

			<div class="bg-blue-500/20 border border-blue-500/30 rounded-lg p-4 mb-6">
				<p class="text-blue-300 text-sm">
					{{ ux_icon('lucide:shield-check', {class: 'w-4 h-4 inline mr-2'}) }}
					Paiement sécurisé par
					<strong>Stripe</strong>. Vos informations de carte ne sont jamais stockées sur nos serveurs.
				</p>
			</div>

			<form method="post" data-turbo="false" class="space-y-6">
				<div class="flex items-start">
					<input type="checkbox" id="confirm_payment" name="confirm_payment" required class="mt-1 w-4 h-4 rounded border-white/20 bg-white/5 text-blue-500 focus:ring-2 focus:ring-blue-500">
					<label for="confirm_payment" class="ml-3 text-sm text-white/80">
						J'accepte de payer l'acompte de
						<strong>{{ deposit.formattedAmount }}</strong>
						pour ce devis. *
					</label>
				</div>

				<div class="space-y-6" data-controller="payment-method">
					<div class="grid grid-cols-1 md:grid-cols-2 gap-4">
						{# Option Carte Bancaire #}
						<label class="relative flex flex-col p-4 bg-white/5 border border-white/10 rounded-xl cursor-pointer hover:bg-white/10 hover:border-blue-500/50 transition-all group">
							<input type="radio" name="payment_method" value="stripe" class="peer sr-only" checked data-action="change->payment-method#toggle" data-payment-method-target="input">
							<span class="absolute top-4 right-4 w-4 h-4 rounded-full border border-white/20 peer-checked:border-blue-500 peer-checked:bg-blue-500 transition-colors"></span>
							<div class="flex items-center gap-3 mb-2">
								<div class="p-2 bg-blue-500/20 rounded-lg text-blue-400 group-hover:bg-blue-500 group-hover:text-white transition-colors">
									{{ ux_icon('lucide:credit-card', {class: 'w-6 h-6'}) }}
								</div>
								<span class="font-semibold text-white">Carte Bancaire</span>
							</div>
							<p class="text-sm text-white/60">Paiement sécurisé immédiat via Stripe.</p>
						</label>

						{# Option Virement / Chèque #}
						<label class="relative flex flex-col p-4 bg-white/5 border border-white/10 rounded-xl cursor-pointer hover:bg-white/10 hover:border-emerald-500/50 transition-all group">
							<input type="radio" name="payment_method" value="manual" class="peer sr-only" data-action="change->payment-method#toggle" data-payment-method-target="input">
							<span class="absolute top-4 right-4 w-4 h-4 rounded-full border border-white/20 peer-checked:border-emerald-500 peer-checked:bg-emerald-500 transition-colors"></span>
							<div class="flex items-center gap-3 mb-2">
								<div class="p-2 bg-emerald-500/20 rounded-lg text-emerald-400 group-hover:bg-emerald-500 group-hover:text-white transition-colors">
									{{ ux_icon('lucide:landmark', {class: 'w-6 h-6'}) }}
								</div>
								<span class="font-semibold text-white">Virement / Chèque</span>
							</div>
							<p class="text-sm text-white/60">Vous recevrez les instructions par email.</p>
						</label>
					</div>

					{# Section Stripe #}
					<div data-payment-method-target="stripeSection" class="space-y-4">
						<button type="submit" name="provider" value="stripe" class="btn-primary w-full py-4 flex items-center justify-center gap-2">
							{{ ux_icon('lucide:credit-card', {class: 'w-5 h-5'}) }}
							Payer {{ deposit.formattedAmount }} par Carte
						</button>
					</div>

					{# Section Manuel #}
					<div data-payment-method-target="manualSection" class="hidden space-y-4">
						<div class="bg-emerald-500/10 border border-emerald-500/20 rounded-lg p-6 space-y-4 text-left">
							<h3 class="text-white font-semibold flex items-center gap-2">
								{{ ux_icon('lucide:landmark', {class: 'w-5 h-5 text-emerald-400'}) }}
								Instructions de paiement
							</h3>

							<div class="space-y-2 text-sm text-white/80">
								<p>Merci de bien vouloir effectuer votre règlement par virement bancaire ou chèque à l'ordre de
									<strong>{{ quote.client.companyName ? companySettings.raisonSociale : (ownerName|default('NOTRE ENTREPRISE')) }}</strong>.</p>

								{% if companySettings and companySettings.iban and companySettings.bic %}
									<div class="bg-black/20 rounded p-3 font-mono text-xs md:text-sm mt-3 border border-white/5">
										<p class="mb-1">
											<span class="text-white/50">IBAN :</span>
											<span class="text-white select-all">{{ companySettings.iban }}</span>
										</p>
										<p>
											<span class="text-white/50">BIC :</span>
											<span class="text-white select-all">{{ companySettings.bic }}</span>
										</p>
									</div>
								{% else %}
									<div class="bg-amber-500/10 border border-amber-500/20 rounded p-3 mt-3">
										<p class="text-amber-300 text-sm">Les coordonnées bancaires vous seront communiquées par email.</p>
									</div>
								{% endif %}

								<p class="mt-3 text-white/60 italic">N'oubliez pas d'indiquer la référence
									<strong>Acompte {{ quote.numero }}</strong>
									dans le libellé du virement.</p>
							</div>
						</div>

						<button type="submit" name="provider" value="manual" class="btn-secondary w-full py-4 flex items-center justify-center gap-2 hover:bg-emerald-600 hover:text-white hover:border-emerald-500 transition-colors">
							{{ ux_icon('lucide:send', {class: 'w-5 h-5'}) }}
							Confirmer le choix par Virement / Chèque
						</button>
					</div>
				</div>

				<div class="flex gap-4">
					<a href="{{ magic_link(quote, 'view') }}" class="btn-secondary flex-1 py-3 text-center">
						Annuler
					</a>
				</div>
			</form>
		</div>
	</div>
{% endblock %}
