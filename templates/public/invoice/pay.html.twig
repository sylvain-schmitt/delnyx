{% extends 'public/layout/base.html.twig' %}

{% block title %}Payer la facture
	{{ invoice.numero }}
	- Delnyx
{% endblock %}

{% block body %}
	<div class="max-w-2xl mx-auto">
		<div class="bg-white/10 backdrop-blur-xl border border-white/20 rounded-xl p-8">
			<h1 class="text-2xl font-bold text-white mb-6">Paiement de la facture</h1>

			<div class="mb-6">
				<p class="text-white/80 mb-2">
					<span class="font-medium text-white">Facture :</span>
					{{ invoice.numero }}
				</p>
				<p class="text-white/80 mb-2">
					<span class="font-medium text-white">Client :</span>
					{{ invoice.client.nomComplet }}
				</p>

				{% if invoice.hasDepositsDeducted() %}
					<p class="text-white/60 mb-1">
						<span class="font-medium">Montant total :</span>
						{{ invoice.montantTTCFormate }}
					</p>
					<p class="text-green-400 mb-1">
						<span class="font-medium">Acomptes déduits :</span>
						-
						{{ invoice.totalDepositsDeductedFormatted }}
					</p>
					<p class="text-2xl font-bold text-green-400 mt-4">
						Solde à payer :
						{{ invoice.balanceDueFormatted }}
					</p>
				{% else %}
					<p class="text-2xl font-bold text-white mt-4">
						Montant à payer :
						{{ invoice.montantTTCFormate }}
					</p>
				{% endif %}
			</div>

			<div class="bg-blue-500/20 border border-blue-500/30 rounded-lg p-4 mb-6">
				<p class="text-blue-300 text-sm">
					{{ ux_icon('lucide:shield-check', {class: 'w-4 h-4 inline mr-2'}) }}
					Paiement sécurisé par
					<strong>Stripe</strong>. Vos informations de carte ne sont jamais stockées sur nos serveurs.
				</p>
			</div>

			<form method="post" data-turbo="false" class="space-y-6">
				<div class="flex items-start">
					<input type="checkbox" id="confirm_payment" name="confirm_payment" required class="mt-1 w-4 h-4 rounded border-white/20 bg-white/5 text-blue-500 focus:ring-2 focus:ring-blue-500">
					<label for="confirm_payment" class="ml-3 text-sm text-white/80">
						J'accepte de payer le montant de
						<strong>{{ invoice.hasDepositsDeducted() ? invoice.balanceDueFormatted : invoice.montantTTCFormate }}</strong>
						pour cette facture. *
					</label>
				</div>

				<div class="space-y-6" data-controller="payment-method">

					<div
						class="grid grid-cols-1 md:grid-cols-2 gap-4">
						{# Option Carte Bancaire #}
						<label class="relative flex flex-col p-4 bg-white/5 border border-white/10 rounded-xl cursor-pointer hover:bg-white/10 hover:border-blue-500/50 transition-all group">
							<input type="radio" name="payment_method" value="stripe" class="peer sr-only" checked data-action="change->payment-method#toggle" data-payment-method-target="input">
							<span class="absolute top-4 right-4 w-4 h-4 rounded-full border border-white/20 peer-checked:border-blue-500 peer-checked:bg-blue-500 transition-colors"></span>
							<div class="flex items-center gap-3 mb-2">
								<div class="p-2 bg-blue-500/20 rounded-lg text-blue-400 group-hover:bg-blue-500 group-hover:text-white transition-colors">
									{{ ux_icon('lucide:credit-card', {class: 'w-6 h-6'}) }}
								</div>
								<span class="font-semibold text-white">Carte Bancaire</span>
							</div>
							<p class="text-sm text-white/60">Paiement sécurisé immédiat via Stripe.</p>
						</label>

						{# Option Virement / Chèque #}
						<label class="relative flex flex-col p-4 bg-white/5 border border-white/10 rounded-xl cursor-pointer hover:bg-white/10 hover:border-emerald-500/50 transition-all group">
							<input type="radio" name="payment_method" value="manual" class="peer sr-only" data-action="change->payment-method#toggle" data-payment-method-target="input">
							<span class="absolute top-4 right-4 w-4 h-4 rounded-full border border-white/20 peer-checked:border-emerald-500 peer-checked:bg-emerald-500 transition-colors"></span>
							<div class="flex items-center gap-3 mb-2">
								<div class="p-2 bg-emerald-500/20 rounded-lg text-emerald-400 group-hover:bg-emerald-500 group-hover:text-white transition-colors">
									{{ ux_icon('lucide:landmark', {class: 'w-6 h-6'}) }}
								</div>
								<span class="font-semibold text-white">Virement / Chèque</span>
							</div>
							<p class="text-sm text-white/60">Vous recevrez les instructions par email.</p>
						</label>
					</div>

					{# Section Stripe #}
					<div data-payment-method-target="stripeSection" class="space-y-4">
						<div class="bg-blue-500/10 border border-blue-500/20 rounded-lg p-4">
							<p class="text-blue-300 text-sm flex gap-2">
								{{ ux_icon('lucide:info', {class: 'w-5 h-5 flex-shrink-0'}) }}
								<span>En payant par carte, vous acceptez le prélèvement automatique pour les éventuels abonnements inclus dans cette facture.</span>
							</p>
						</div>
						<button type="submit" name="provider" value="stripe" class="btn-primary w-full py-4 flex items-center justify-center gap-2">
							{{ ux_icon('lucide:credit-card', {class: 'w-5 h-5'}) }}
							Payer
							{{ invoice.hasDepositsDeducted() ? invoice.balanceDueFormatted : invoice.montantTTCFormate }}
							par Carte
						</button>
					</div>

					{# Section Manuel #}
					<div data-payment-method-target="manualSection" class="hidden space-y-4">
						<div class="bg-emerald-500/10 border border-emerald-500/20 rounded-lg p-6 space-y-4">
							<h3 class="text-white font-semibold flex items-center gap-2">
								{{ ux_icon('lucide:landmark', {class: 'w-5 h-5 text-emerald-400'}) }}
								Instructions de paiement
							</h3>

							<div class="space-y-2 text-sm text-white/80">
								<p>Merci de bien vouloir effectuer votre règlement par virement bancaire ou chèque à l'ordre de
									<strong>{{ ownerName }}</strong>.</p>

								{% if companySettings and companySettings.iban and companySettings.bic %}
									<div class="bg-black/20 rounded p-3 font-mono text-xs md:text-sm mt-3 border border-white/5">
										<p class="mb-1">
											<span class="text-white/50">IBAN :</span>
											<span class="text-white select-all">{{ companySettings.iban }}</span>
										</p>
										<p>
											<span class="text-white/50">BIC :</span>
											<span class="text-white select-all">{{ companySettings.bic }}</span>
										</p>
									</div>
								{% else %}
									<div class="bg-amber-500/10 border border-amber-500/20 rounded p-3 mt-3">
										<p class="text-amber-300 text-sm">Les coordonnées bancaires vous seront communiquées par email.</p>
									</div>
								{% endif %}

								<p class="mt-3 text-white/60 italic">N'oubliez pas d'indiquer le numéro de facture
									<strong>{{ invoice.numero }}</strong>
									dans le libellé du virement.</p>
							</div>
						</div>

						<div class="flex items-start">
							<input type="checkbox" id="confirm_manual" name="confirm_manual" class="mt-1 w-4 h-4 rounded border-white/20 bg-white/5 text-emerald-500 focus:ring-2 focus:ring-emerald-500">
							<label for="confirm_manual" class="ml-3 text-sm text-white/80 cursor-pointer">
								Je confirme que je vais procéder au règlement par virement ou chèque prochainement.
							</label>
						</div>

						<button type="submit" name="provider" value="manual" class="btn-secondary w-full py-4 flex items-center justify-center gap-2 hover:bg-emerald-600 hover:text-white hover:border-emerald-500 transition-colors">
							{{ ux_icon('lucide:send', {class: 'w-5 h-5'}) }}
							Confirmer le choix de paiement
						</button>
					</div>

				</div>

				<div class="flex gap-4">
					<a href="{{ magic_link(invoice, 'view') }}" class="btn-secondary flex-1 py-3 text-center">
						Annuler
					</a>
				</div>
			</form>
		</div>
	</div>
{% endblock %}
