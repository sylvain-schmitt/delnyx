{% extends 'admin/layout/base.html.twig' %}
{% import 'admin/macros/form_fields.html.twig' as form_macros %}

{% block page_title %}Paramètres de l'Entreprise
{% endblock %}

{% block breadcrumb %}
	<span class="text-white/40">/</span>
	<span class="text-white/80">Paramètres Entreprise</span>
{% endblock %}

{% block body %}
	<div class="p-6 space-y-6">
		<div class="bg-white/5 backdrop-blur-xl rounded-2xl border border-white/10 p-6 shadow-2xl">
			<h2 class="text-2xl font-bold text-white mb-6">Configuration de l'Entreprise</h2>

			{# Afficher les erreurs du formulaire #}
			{% if not form.vars.valid %}
				<div class="mb-4 p-4 bg-red-500/20 border border-red-500/30 rounded-lg">
					<p class="text-red-300 font-medium mb-2">Erreurs dans le formulaire :</p>
					{{ form_errors(form) }}
				</div>
			{% endif %}

			{{ form_start(form, {'attr': {
            'class': 'space-y-6',
            'data-controller': 'admin-form',
            'data-admin-form-target': 'form',
            'novalidate': 'novalidate',
            'data-action': 'submit->admin-form#handleSubmit',
            'enctype': 'multipart/form-data'
        }}) }}

			{# Informations Entreprise #}
			<div class="space-y-4">
				<h3 class="text-lg font-semibold text-white/90 border-b border-white/20 pb-2">Informations Entreprise</h3>

				<div class="grid grid-cols-1 md:grid-cols-2 gap-4">
					{{ form_macros.simple_field(form, 'raisonSociale') }}
					{{ form_macros.simple_field(form, 'siren') }}
					{{ form_macros.simple_field(form, 'siret') }}
					{{ form_macros.simple_field(form, 'email') }}
					{{ form_macros.simple_field(form, 'telephone') }}
				</div>

				{{ form_macros.simple_field(form, 'adresse', 'textarea') }}

				<div class="grid grid-cols-1 md:grid-cols-2 gap-4">
					{{ form_macros.simple_field(form, 'codePostal') }}
					{{ form_macros.simple_field(form, 'ville') }}
				</div>

				{# Logo #}
				<div class="space-y-2 form-group">
					{{ form_label(form.logo, null, {'label_attr': {'class': 'block text-sm font-medium text-white/90'}}) }}
					{% if companySettings.logoPath %}
						<div class="mb-4">
							<img src="{{ asset(companySettings.logoPath) }}" alt="Logo actuel" class="h-20 w-auto object-contain bg-white/10 rounded-lg p-2">
							<p class="text-white/60 text-sm mt-2">Logo actuel</p>
						</div>
					{% endif %}
					{{ form_widget(form.logo, {'attr': {
                    'class': 'block w-full text-sm text-white/80 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-blue-500 file:text-white hover:file:bg-blue-600',
                    'data-admin-form-target': 'field'
                }}) }}
					{{ form_help(form.logo) }}
					{{ form_errors(form.logo) }}
				</div>
			</div>

			{# Mentions Légales Obligatoires #}
			<div class="space-y-4 pt-6 border-t border-white/20">
				<h3 class="text-lg font-semibold text-white/90 border-b border-white/20 pb-2">Mentions Légales</h3>

				<div class="grid grid-cols-1 md:grid-cols-2 gap-4">
					{{ form_macros.simple_field(form, 'formeJuridique', 'select') }}
					{{ form_macros.simple_field(form, 'codeAPE') }}
				</div>

				{{ form_macros.simple_field(form, 'assuranceRCPro', 'textarea') }}

				<div class="grid grid-cols-1 md:grid-cols-2 gap-4">
					{{ form_macros.simple_field(form, 'indemniteForfaitaireRecouvrement') }}
				</div>
			</div>

			{# Configuration Bancaire #}
			<div class="space-y-4 pt-6 border-t border-white/20">
				<h3 class="text-lg font-semibold text-white/90 border-b border-white/20 pb-2">Configuration Bancaire</h3>

				<div class="grid grid-cols-1 md:grid-cols-2 gap-4">
					{{ form_macros.simple_field(form, 'iban') }}
					{{ form_macros.simple_field(form, 'bic') }}
				</div>
			</div>

			{# Configuration TVA #}
			<div class="space-y-4 pt-6 border-t border-white/20">
				<h3 class="text-lg font-semibold text-white/90 border-b border-white/20 pb-2">Configuration TVA</h3>

				<div
					class="grid grid-cols-1 md:grid-cols-2 gap-4" data-controller="tva-settings">
					{# Checkbox TVA - style personnalisé sans bordure #}
					<div class="form-group">
						{{ form_label(form.tvaEnabled, null, {'label_attr': {'class': 'form-label'}}) }}
						{{ form_widget(form.tvaEnabled, {'attr': {
							'class': 'form-checkbox',
							'data-admin-form-target': 'field',
							'data-tva-settings-target': 'toggle',
							'data-action': 'change->tva-settings#toggleRate'
						}}) }}
						{{ form_help(form.tvaEnabled) }}
						{{ form_errors(form.tvaEnabled) }}
					</div>
					{% if form.tauxTVADefaut is defined %}
						<div data-tva-settings-target="rateWrapper" class="{{ form.tvaEnabled.vars.data ? '' : 'hidden' }}">
							{{ form_macros.simple_field(form, 'tauxTVADefaut', 'select') }}
						</div>
					{% endif %}
				</div>
			</div>

			{# Configuration PDP #}
			<div class="space-y-4 pt-6 border-t border-white/20">
				<h3 class="text-lg font-semibold text-white/90 border-b border-white/20 pb-2">Facturation Électronique (PDP)</h3>

				<div class="grid grid-cols-1 md:grid-cols-2 gap-4">
					{{ form_macros.simple_field(form, 'pdpMode', 'select') }}
					{{ form_macros.simple_field(form, 'pdpProvider') }}
				</div>

				{{ form_macros.simple_field(form, 'pdpApiKey') }}
			</div>

			{# Configuration Signature #}
			<div class="space-y-4 pt-6 border-t border-white/20">
				<h3 class="text-lg font-semibold text-white/90 border-b border-white/20 pb-2">Signature Électronique</h3>

				<div class="grid grid-cols-1 md:grid-cols-2 gap-4">
					{{ form_macros.simple_field(form, 'signatureProvider', 'select') }}
					{{ form_macros.simple_field(form, 'signatureApiKey') }}
				</div>
			</div>

			{# Configuration Stripe #}
			<div class="space-y-4 pt-6 border-t border-white/20">
				<div class="flex items-center justify-between pb-2 border-b border-white/20">
					<h3 class="text-lg font-semibold text-white/90">Paiement en ligne (Stripe)</h3>
					<a href="https://dashboard.stripe.com/apikeys" target="_blank" class="text-xs text-blue-400 hover:text-blue-300 flex items-center gap-1">
						{{ ux_icon('lucide:external-link', {class: 'w-3 h-3'}) }}
						Obtenir vos clés
					</a>
				</div>

				{# Checkbox d'activation #}
				<div class="form-group flex items-center gap-3 bg-white/5 p-4 rounded-lg">
					{{ form_widget(form.stripeEnabled, {'attr': {'class': 'form-checkbox', 'data-admin-form-target': 'field'}}) }}
					<div>
						<span class="text-white font-medium">{{ form.stripeEnabled.vars.label }}</span>
						<p class="text-white/60 text-sm">Permet de payer les factures et acomptes par carte bancaire</p>
					</div>
				</div>

				<div
					class="grid grid-cols-1 md:grid-cols-2 gap-4">
					{# Clé publique #}
					<div class="form-group">
						{{ form_label(form.stripePublishableKey, null, {'label_attr': {'class': 'form-label'}}) }}
						{{ form_widget(form.stripePublishableKey, {'attr': {'class': 'form-input', 'data-admin-form-target': 'field'}}) }}
						{% if companySettings.stripePublishableKey %}
							<p class="text-green-400 text-xs mt-1 flex items-center gap-1">
								{{ ux_icon('lucide:check-circle', {class: 'w-3 h-3'}) }}
								Clé configurée (pk_***{{ companySettings.stripePublishableKey[-8:] }})
							</p>
						{% endif %}
						{{ form_help(form.stripePublishableKey) }}
						{{ form_errors(form.stripePublishableKey) }}
					</div>

					{# Clé secrète #}
					<div class="form-group">
						{{ form_label(form.stripeSecretKey, null, {'label_attr': {'class': 'form-label'}}) }}
						{{ form_widget(form.stripeSecretKey, {'attr': {'class': 'form-input', 'data-admin-form-target': 'field'}}) }}
						{% if companySettings.stripeSecretKey %}
							<p class="text-green-400 text-xs mt-1 flex items-center gap-1">
								{{ ux_icon('lucide:check-circle', {class: 'w-3 h-3'}) }}
								Clé configurée (sk_***...{{ companySettings.stripeSecretKey[-4:] }})
							</p>
						{% else %}
							<p class="text-amber-400 text-xs mt-1 flex items-center gap-1">
								{{ ux_icon('lucide:alert-circle', {class: 'w-3 h-3'}) }}
								Non configurée
							</p>
						{% endif %}
						{{ form_help(form.stripeSecretKey) }}
						{{ form_errors(form.stripeSecretKey) }}
					</div>
				</div>

				{# Secret webhook #}
				<div class="form-group">
					{{ form_label(form.stripeWebhookSecret, null, {'label_attr': {'class': 'form-label'}}) }}
					{{ form_widget(form.stripeWebhookSecret, {'attr': {'class': 'form-input', 'data-admin-form-target': 'field'}}) }}
					{% if companySettings.stripeWebhookSecret %}
						<p class="text-green-400 text-xs mt-1 flex items-center gap-1">
							{{ ux_icon('lucide:check-circle', {class: 'w-3 h-3'}) }}
							Secret configuré (whsec_***...{{ companySettings.stripeWebhookSecret[-4:] }})
						</p>
					{% else %}
						<p class="text-amber-400 text-xs mt-1 flex items-center gap-1">
							{{ ux_icon('lucide:alert-circle', {class: 'w-3 h-3'}) }}
							Non configuré
						</p>
					{% endif %}
					{{ form_help(form.stripeWebhookSecret) }}
					{{ form_errors(form.stripeWebhookSecret) }}
				</div>

				<div class="text-sm text-blue-200">
					<p class="font-medium">Configuration du webhook Stripe</p>
					<p class="text-blue-300/80 mt-1">Dans votre
						<a href="https://dashboard.stripe.com/webhooks" target="_blank" class="underline hover:text-blue-200">Dashboard Stripe → Webhooks</a>, ajoutez cette URL :</p>
					<code class="block bg-blue-900/50 px-3 py-2 rounded text-xs mt-2 select-all">{{ app.request.schemeAndHttpHost }}/webhook/stripe</code>
					<p class="text-blue-400/70 text-xs mt-2 italic">⚠️ Cette URL n'est pas visitable directement - elle accepte uniquement les requêtes POST envoyées par Stripe.</p>
				</div>
			</div>

			{# Configuration Google Reviews #}
			<div class="space-y-4 pt-6 border-t border-white/20">
				<div class="flex items-center justify-between pb-2 border-b border-white/20">
					<h3 class="text-lg font-semibold text-white/90">Avis Google Business</h3>
					<a href="https://console.cloud.google.com/" target="_blank" class="text-xs text-blue-400 hover:text-blue-300 flex items-center gap-1">
						{{ ux_icon('lucide:external-link', {class: 'w-3 h-3'}) }}
						Google Cloud Console
					</a>
				</div>

				{# Checkbox d'activation #}
				<div class="form-group flex items-center gap-3 bg-white/5 p-4 rounded-lg">
					{{ form_widget(form.googleReviewsEnabled, {'attr': {'class': 'form-checkbox', 'data-admin-form-target': 'field'}}) }}
					<div>
						<span class="text-white font-medium">{{ form.googleReviewsEnabled.vars.label }}</span>
						<p class="text-white/60 text-sm">Affiche vos derniers avis Google sur la page d'accueil</p>
					</div>
				</div>

				<div
					class="grid grid-cols-1 md:grid-cols-2 gap-4">
					{# Place ID #}
					<div class="form-group">
						{{ form_label(form.googlePlaceId, null, {'label_attr': {'class': 'form-label'}}) }}
						{{ form_widget(form.googlePlaceId, {'attr': {'class': 'form-input', 'data-admin-form-target': 'field'}}) }}
						{% if companySettings.googlePlaceId %}
							<p class="text-green-400 text-xs mt-1 flex items-center gap-1">
								{{ ux_icon('lucide:check-circle', {class: 'w-3 h-3'}) }}
								ID configuré ({{ companySettings.googlePlaceId[:12] }}...)
							</p>
						{% endif %}
						{{ form_help(form.googlePlaceId) }}
						{{ form_errors(form.googlePlaceId) }}
					</div>

					{# API Key #}
					<div class="form-group">
						{{ form_label(form.googleApiKey, null, {'label_attr': {'class': 'form-label'}}) }}
						{{ form_widget(form.googleApiKey, {'attr': {'class': 'form-input', 'data-admin-form-target': 'field'}}) }}
						{% if companySettings.googleApiKey %}
							<p class="text-green-400 text-xs mt-1 flex items-center gap-1">
								{{ ux_icon('lucide:check-circle', {class: 'w-3 h-3'}) }}
								Clé configurée (AIza...{{ companySettings.googleApiKey[-4:] }})
							</p>
						{% else %}
							<p class="text-amber-400 text-xs mt-1 flex items-center gap-1">
								{{ ux_icon('lucide:alert-circle', {class: 'w-3 h-3'}) }}
								Non configurée
							</p>
						{% endif %}
						{{ form_help(form.googleApiKey) }}
						{{ form_errors(form.googleApiKey) }}
					</div>
				</div>

				{# Automatisation #}
				<div class="space-y-4 pt-6 border-t border-white/20">
					<h3 class="text-lg font-semibold text-white/90 border-b border-white/20 pb-2">Automatisation</h3>

					<div class="bg-white/5 border border-white/10 rounded-lg p-4">
						<div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
							<div class="flex items-start gap-4">
								{{ ux_icon('lucide:bell', {class: 'w-8 h-8 text-blue-400 flex-shrink-0'}) }}
								<div>
									<h4 class="text-white font-medium">Relances automatiques</h4>
									<p class="text-white/60 text-sm">Configurez des règles pour envoyer automatiquement des rappels aux clients avec des factures impayées.</p>
								</div>
							</div>
							<a href="{{ path('admin_reminder_index') }}" class="btn-secondary flex items-center justify-center gap-2 text-sm flex-shrink-0">
								{{ ux_icon('lucide:settings', {class: 'w-4 h-4'}) }}
								Configurer
							</a>
						</div>
					</div>
				</div>

				{# Submit Button #}
				<div class="pt-6 border-t border-white/20">
					{{ form_widget(form.submit, {'attr': {
                'class': 'px-6 py-3 bg-gradient-to-r from-blue-500 to-purple-500 text-white font-semibold rounded-xl hover:from-blue-600 hover:to-purple-600 transition-all duration-300 shadow-lg shadow-blue-500/25 hover:shadow-blue-500/40',
                'data-admin-form-target': 'submit'
            }}) }}
				</div>

				{{ form_end(form) }}
			</div>
		</div>
	{% endblock %}
