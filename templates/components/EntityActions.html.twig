{% props entity, type, layout = 'inline' %}

{#
    Composant réutilisable pour afficher les boutons d'actions d'une entité

    Paramètres:
    - entity: L'entité (Quote, Invoice, Amendment, CreditNote)
    - type: Le type d'entité ('quote', 'invoice', 'amendment', 'credit_note')
    - layout: 'inline' (pour index desktop), 'vertical' (pour show), ou 'mobile' (pour cards mobiles)
#}

{% if layout == 'mobile' %}
	{# Layout mobile : grid responsive avec boutons compacts #}
	{% set containerClass = 'grid grid-cols-2 sm:grid-cols-3 gap-2' %}
	{% set buttonClass = 'btn-sm btn-primary flex items-center justify-center gap-1.5 text-xs' %}
	{% set secondaryButtonClass = 'btn-sm btn-secondary flex items-center justify-center gap-1.5 text-xs' %}
	{% set dangerButtonClass = 'btn-sm btn-danger flex items-center justify-center gap-1.5 text-xs' %}
	{% set successButtonClass = 'btn-sm btn-success flex items-center justify-center gap-1.5 text-xs' %}
	{% set showText = true %}
{% elseif layout == 'vertical' %}
	{# Layout vertical : show page #}
	{% set containerClass = 'space-y-3' %}
	{% set buttonClass = 'w-full btn-primary flex items-center justify-center gap-2' %}
	{% set secondaryButtonClass = 'w-full btn-secondary flex items-center justify-center gap-2' %}
	{% set dangerButtonClass = 'w-full btn-danger flex items-center justify-center gap-2' %}
	{% set successButtonClass = 'w-full btn-success flex items-center justify-center gap-2' %}
	{% set showText = true %}
{% else %}
	{# Layout inline : index desktop #}
	{% set containerClass = 'flex items-center gap-2' %}
	{% set buttonClass = 'text-blue-400 hover:text-blue-300 transition-colors duration-200' %}
	{% set secondaryButtonClass = 'text-yellow-400 hover:text-yellow-300 transition-colors duration-200' %}
	{% set dangerButtonClass = 'text-red-400 hover:text-red-300 transition-colors duration-200' %}
	{% set successButtonClass = 'text-green-400 hover:text-green-300 transition-colors duration-200' %}
	{% set showText = false %}
{% endif %}

<div
	class="{{ containerClass }}">
	{# Bouton Voir (index uniquement) #}
	{% if layout == 'inline' %}
		<a href="{{ path('admin_' ~ type ~ '_show', {id: entity.id}) }}" class="{{ buttonClass }}" title="Voir">
			{{ ux_icon('lucide:eye', {class: layout == 'mobile' ? 'w-3.5 h-3.5' : 'w-4 h-4'}) }}
		</a>
	{% elseif layout == 'mobile' %}
		<a href="{{ path('admin_' ~ type ~ '_show', {id: entity.id}) }}" class="{{ buttonClass }}">
			{{ ux_icon('lucide:eye', {class: 'w-3.5 h-3.5'}) }}
			Voir
		</a>
	{% endif %}

	{# Définir hasEmail et recipientEmail pour tous les boutons email #}
	{% set hasEmail = false %}
	{% set recipientEmail = '' %}
	{% if type == 'quote' or type == 'invoice' %}
		{% set hasEmail = entity.client is defined and entity.client and entity.client.email %}
		{% set recipientEmail = hasEmail ? entity.client.email : '' %}
	{% elseif type == 'amendment' %}
		{% set hasEmail = entity.quote is defined and entity.quote and entity.quote.client and entity.quote.client.email %}
		{% set recipientEmail = hasEmail ? entity.quote.client.email : '' %}
	{% elseif type == 'credit_note' %}
		{% set hasEmail = entity.invoice is defined and entity.invoice and entity.invoice.client and entity.invoice.client.email %}
		{% set recipientEmail = hasEmail ? entity.invoice.client.email : '' %}
	{% endif %}

	{# Bouton Modifier #}
	{% if is_granted(type|upper ~ '_EDIT', entity) %}
		<a href="{{ path('admin_' ~ type ~ '_edit', {id: entity.id}) }}" class="{{ secondaryButtonClass }}" title="Modifier">
			{{ ux_icon(layout == 'mobile' ? 'lucide:edit' : 'lucide:edit', {class: layout == 'mobile' ? 'w-3.5 h-3.5' : 'w-4 h-4'}) }}
			{% if showText %}Modifier
			{% endif %}
		</a>
	{% endif %}

	{# Boutons spécifiques Invoice #}
	{% if type == 'invoice' %}
		{# Bouton Émettre (DRAFT uniquement) #}
		{% if is_granted('INVOICE_ISSUE', entity) and entity.statutEnum.value == 'draft' %}
			<form action="{{ path('admin_invoice_issue', {id: entity.id}) }}" method="POST" class="{{ layout == 'inline' ? 'inline' : (layout == 'mobile' ? 'contents' : 'w-full') }}">
				<input type="hidden" name="_token" value="{{ csrf_token('invoice_issue_' ~ entity.id) }}">
				<button type="submit" class="{{ secondaryButtonClass }}" title="Émettre">
					{{ ux_icon('lucide:file-check', {class: layout == 'mobile' ? 'w-3.5 h-3.5' : 'w-4 h-4'}) }}
					{% if showText %}Émettre
					{% endif %}
				</button>
			</form>
		{% endif %}

		{# Bouton Émettre & Envoyer (DRAFT uniquement) #}
		{% if is_granted('INVOICE_ISSUE', entity) and entity.statutEnum.value == 'draft' and hasEmail %}
			<button type="button" class="{{ buttonClass }}" title="Émettre et envoyer" data-controller="email-trigger" data-email-trigger-url-value="{{ path('admin_invoice_issue_and_send', {id: entity.id}) }}" data-email-trigger-csrf-token-value="{{ csrf_token('invoice_issue_and_send_' ~ entity.id) }}" data-email-trigger-recipient-value="{{ recipientEmail }}" data-email-trigger-document-type-value="{{ type }}" data-email-trigger-document-number-value="{{ entity.numero }}" data-action="click->email-trigger#open">
				{{ ux_icon('lucide:send', {class: layout == 'mobile' ? 'w-3.5 h-3.5' : 'w-4 h-4'}) }}
				{% if showText %}Émettre & Envoyer
				{% endif %}
			</button>
		{% endif %}

		{# Bouton Envoyer (ISSUED uniquement) #}
		{% if is_granted('INVOICE_SEND', entity) and entity.statutEnum.value == 'issued' and hasEmail %}
			<button type="button" class="{{ buttonClass }}" title="Envoyer par email" data-controller="email-trigger" data-email-trigger-url-value="{{ path('admin_invoice_send_email', {id: entity.id}) }}" data-email-trigger-csrf-token-value="{{ csrf_token('invoice_send_email_' ~ entity.id) }}" data-email-trigger-recipient-value="{{ recipientEmail }}" data-email-trigger-document-type-value="{{ type }}" data-email-trigger-document-number-value="{{ entity.numero }}" data-action="click->email-trigger#open">
				{{ ux_icon('lucide:mail', {class: layout == 'mobile' ? 'w-3.5 h-3.5' : 'w-4 h-4'}) }}
				{% if showText %}Envoyer la facture
				{% endif %}
			</button>
		{% endif %}

		{# Bouton Relancer (SENT uniquement) #}
		{% if entity.statutEnum.value == 'sent' and hasEmail %}
			<button type="button" class="{{ layout == 'inline' ? buttonClass : secondaryButtonClass }}" title="Relancer le client" data-controller="email-trigger" data-email-trigger-url-value="{{ path('admin_invoice_send_email', {id: entity.id}) }}" data-email-trigger-csrf-token-value="{{ csrf_token('invoice_send_email_' ~ entity.id) }}" data-email-trigger-recipient-value="{{ recipientEmail }}" data-email-trigger-document-type-value="{{ type }}" data-email-trigger-document-number-value="{{ entity.numero }}" data-email-trigger-is-reminder-value="true" data-action="click->email-trigger#open">
				{{ ux_icon('lucide:bell', {class: layout == 'mobile' ? 'w-3.5 h-3.5' : 'w-4 h-4'}) }}
				{% if showText %}Relancer le client
				{% endif %}
			</button>
		{% endif %}
	{% else %}
		{# Bouton Envoyer par email - UNIQUEMENT pour DRAFT (Quote, Amendment) #}
		{# Note: Les avoirs (CreditNote) ont leurs propres boutons spécifiques ci-dessus #}
		{% if type != 'credit_note' and is_granted(type|upper ~ '_SEND', entity) and entity.statut.value == 'draft' and hasEmail %}
			{# Récupérer le numéro du document selon le type d'entité #}
			{% set documentNumber = type == 'credit_note' ? entity.number : entity.numero %}

			<button type="button" class="{{ buttonClass }}" title="Envoyer par email" data-controller="email-trigger" data-email-trigger-url-value="{{ path('admin_' ~ type ~ '_send_email', {id: entity.id}) }}" data-email-trigger-csrf-token-value="{{ csrf_token(type ~ '_send_email_' ~ entity.id) }}" data-email-trigger-recipient-value="{{ recipientEmail }}" data-email-trigger-document-type-value="{{ type }}" data-email-trigger-document-number-value="{{ documentNumber }}" data-action="click->email-trigger#open">
				{{ ux_icon('lucide:mail', {class: layout == 'mobile' ? 'w-3.5 h-3.5' : 'w-4 h-4'}) }}
				{% if showText %}
					Envoyer
					{% if type == 'quote' %}
						le devis
					{% elseif type == 'amendment' %}
						l'avenant
					{% endif %}
				{% endif %}
			</button>
		{% elseif type != 'credit_note' and is_granted(type|upper ~ '_SEND', entity) and entity.statut.value == 'draft' and not hasEmail %}
			{# Message si pas d'email configuré (seulement en mode vertical) #}
			{% if layout != 'inline' %}
				<span class="{{ layout == 'mobile' ? 'btn-sm btn-secondary opacity-50 cursor-not-allowed flex items-center justify-center gap-1.5 text-xs' : 'w-full btn-secondary opacity-50 cursor-not-allowed flex items-center justify-center gap-2' }}" title="Aucun email client configuré">
					{{ ux_icon('lucide:mail-x', {class: layout == 'mobile' ? 'w-3.5 h-3.5' : 'w-4 h-4'}) }}
					{% if showText %}Email non configuré
					{% endif %}
				</span>
			{% endif %}
		{% endif %}
	{% endif %}

	{# Boutons spécifiques Quote #}
	{% if type == 'quote' %}
		{# Relancer le client (seulement pour SENT) #}
		{% if entity.statut.value == 'sent' and hasEmail %}
			<button type="button" class="{{ layout == 'inline' ? buttonClass : secondaryButtonClass }}" title="Relancer le client" data-controller="email-trigger" data-email-trigger-url-value="{{ path('admin_quote_remind', {id: entity.id}) }}" data-email-trigger-csrf-token-value="{{ csrf_token('quote_remind_' ~ entity.id) }}" data-email-trigger-recipient-value="{{ recipientEmail }}" data-email-trigger-document-type-value="{{ type }}" data-email-trigger-document-number-value="{{ entity.numero }}" data-email-trigger-is-reminder-value="true" data-action="click->email-trigger#open">
				{{ ux_icon('lucide:bell', {class: layout == 'mobile' ? 'w-3.5 h-3.5' : 'w-4 h-4'}) }}
				{% if showText %}Relancer le client
				{% endif %}
			</button>
		{% endif %}

		{# Modifier (retour en DRAFT depuis SENT uniquement) #}
		{% if entity.statut.value == 'sent' %}
			<form action="{{ path('admin_quote_back_to_draft', {id: entity.id}) }}" method="POST" class="{{ layout == 'inline' ? 'inline' : (layout == 'mobile' ? 'contents' : 'w-full') }}" data-action="submit->confirm-modal#open" data-confirm-modal-message="⚠️ Le devis sera repassé en brouillon pour modification. Continuer ?" data-confirm-modal-title="Modifier le devis" data-confirm-modal-button="Oui, modifier">
				<input type="hidden" name="_token" value="{{ csrf_token('quote_back_to_draft_' ~ entity.id) }}">
				<button type="submit" class="{{ secondaryButtonClass }}" title="Modifier (repasser en brouillon)">
					{{ ux_icon('lucide:edit', {class: layout == 'mobile' ? 'w-3.5 h-3.5' : 'w-4 h-4'}) }}
					{% if showText %}Modifier
					{% endif %}
				</button>
			</form>
		{% endif %}

		{# Signer - SIMPLIFIÉ : seulement depuis SENT #}
		{% if is_granted('QUOTE_SIGN', entity) %}
			<form action="{{ path('admin_quote_sign', {id: entity.id}) }}" method="POST" class="{{ layout == 'inline' ? 'inline' : (layout == 'mobile' ? 'contents' : 'w-full') }}" data-action="submit->confirm-modal#open" data-confirm-modal-message="⚠️ ATTENTION : Signer ce devis le transforme en CONTRAT et le rend immuable. Continuer ?" data-confirm-modal-title="Confirmer la signature" data-confirm-modal-button="Signer">
				<input type="hidden" name="_token" value="{{ csrf_token('quote_sign_' ~ entity.id) }}">
				<button type="submit" class="{{ layout == 'inline' ? 'text-purple-400 hover:text-purple-300 transition-colors duration-200' : buttonClass }}" title="Signer">
					{{ ux_icon('lucide:pen-tool', {class: layout == 'mobile' ? 'w-3.5 h-3.5' : 'w-4 h-4'}) }}
					{% if showText %}Signer
					{% endif %}
				</button>
			</form>
		{% endif %}
	{% endif %}

	{# Boutons spécifiques Amendment #}
	{% if type == 'amendment' %}
		{# Relancer le client (seulement pour SENT) #}
		{% if entity.statut.value == 'sent' and hasEmail %}
			<button type="button" class="{{ layout == 'inline' ? buttonClass : secondaryButtonClass }}" title="Relancer le client" data-controller="email-trigger" data-email-trigger-url-value="{{ path('admin_amendment_remind', {id: entity.id}) }}" data-email-trigger-csrf-token-value="{{ csrf_token('amendment_remind_' ~ entity.id) }}" data-email-trigger-recipient-value="{{ recipientEmail }}" data-email-trigger-document-type-value="{{ type }}" data-email-trigger-document-number-value="{{ entity.numero }}" data-email-trigger-is-reminder-value="true" data-action="click->email-trigger#open">
				{{ ux_icon('lucide:bell', {class: layout == 'mobile' ? 'w-3.5 h-3.5' : 'w-4 h-4'}) }}
				{% if showText %}Relancer le client{% endif %}
			</button>
		{% endif %}

		{# Modifier (retour en DRAFT depuis SENT uniquement) #}
		{% if entity.statut.value == 'sent' %}
			<form action="{{ path('admin_amendment_back_to_draft', {id: entity.id}) }}" method="POST" class="{{ layout == 'inline' ? 'inline' : (layout == 'mobile' ? 'contents' : 'w-full') }}" data-action="submit->confirm-modal#open" data-confirm-modal-message="⚠️ L'avenant sera repassé en brouillon pour modification. Continuer ?" data-confirm-modal-title="Modifier l'avenant" data-confirm-modal-button="Oui, modifier">
				<input type="hidden" name="_token" value="{{ csrf_token('amendment_back_to_draft_' ~ entity.id) }}">
				<button type="submit" class="{{ secondaryButtonClass }}" title="Modifier (repasser en brouillon)">
					{{ ux_icon('lucide:edit', {class: layout == 'mobile' ? 'w-3.5 h-3.5' : 'w-4 h-4'}) }}
					{% if showText %}Modifier{% endif %}
				</button>
			</form>
		{% endif %}

		{# Signer - SIMPLIFIÉ : seulement depuis SENT #}
		{% if is_granted('AMENDMENT_SIGN', entity) %}
			<form action="{{ path('admin_amendment_sign', {id: entity.id}) }}" method="POST" class="{{ layout == 'inline' ? 'inline' : (layout == 'mobile' ? 'contents' : 'w-full') }}" data-action="submit->confirm-modal#open" data-confirm-modal-message="⚠️ ATTENTION : Signer cet avenant le rend opposable et immuable. Continuer ?" data-confirm-modal-title="Confirmer la signature" data-confirm-modal-button="Signer">
				<input type="hidden" name="_token" value="{{ csrf_token('amendment_sign_' ~ entity.id) }}">
				<button type="submit" class="{{ layout == 'inline' ? 'text-purple-400 hover:text-purple-300 transition-colors duration-200' : buttonClass }}" title="Signer">
					{{ ux_icon('lucide:pen-tool', {class: layout == 'mobile' ? 'w-3.5 h-3.5' : 'w-4 h-4'}) }}
					{% if showText %}Signer{% endif %}
				</button>
			</form>
		{% endif %}
	{% endif %}

	{# Boutons spécifiques Invoice #}
	{% if type == 'invoice' %}
		{# Marquer comme payée #}
		{% if is_granted('INVOICE_MARK_PAID', entity) %}
			<form action="{{ path('admin_invoice_mark_paid', {id: entity.id}) }}" method="POST" class="{{ layout == 'inline' ? 'inline' : (layout == 'mobile' ? 'contents' : 'w-full') }}">
				<input type="hidden" name="_token" value="{{ csrf_token('invoice_mark_paid_' ~ entity.id) }}">
				<button type="submit" class="{{ successButtonClass }}" title="Marquer comme payée">
					{{ ux_icon('lucide:check-circle', {class: layout == 'mobile' ? 'w-3.5 h-3.5' : 'w-4 h-4'}) }}
					{% if showText %}Marquer comme payée
					{% endif %}
				</button>
			</form>
		{% endif %}

		{# Créer un avoir #}
		{% if is_granted('INVOICE_CREATE_CREDITNOTE', entity) %}
			<a href="{{ path('admin_credit_note_new', {invoice_id: entity.id}) }}" class="{{ layout == 'inline' ? buttonClass : secondaryButtonClass }}" title="Créer un avoir">
				{{ ux_icon('lucide:file-minus', {class: layout == 'mobile' ? 'w-3.5 h-3.5' : 'w-4 h-4'}) }}
				{% if showText %}Créer un avoir
				{% endif %}
			</a>
		{% endif %}
	{% endif %}

	{# Boutons spécifiques CreditNote #}
	{% if type == 'credit_note' %}
		{% set isStripeRefundable = false %}
		{% if entity.invoice %}
			{# Vérifier s'il y a un paiement Stripe (succès OU en attente si facture payée manuellement) #}
			{% set hasStripeCandidate = false %}
			{% for payment in entity.invoice.payments %}
				{% if payment.provider.value == 'stripe' %}
					{% if payment.status.value == 'succeeded' or (entity.invoice.statut == 'paid' and payment.status.value == 'pending') %}
						{% set hasStripeCandidate = true %}
					{% endif %}
				{% endif %}
			{% endfor %}

			{# Éligible si candidat Stripe présent ET pas encore remboursé via Stripe sur cet avoir #}
			{% if hasStripeCandidate and not entity.stripeRefundId %}
				{% set isStripeRefundable = true %}
			{% endif %}
		{% endif %}

		{# Bouton Émettre & Rembourser via Stripe (DRAFT uniquement, si facture payée par Stripe) #}
		{% if isStripeRefundable and entity.statutEnum.value == 'draft' %}
			<form action="{{ path('admin_credit_note_issue_and_refund', {id: entity.id}) }}" method="POST" class="{{ layout == 'inline' ? 'inline' : (layout == 'mobile' ? 'contents' : 'w-full') }}" data-action="submit->confirm-modal#open" data-confirm-modal-message="L'avoir sera émis, envoyé au client, et le remboursement sera déclenché sur Stripe. Continuer ?" data-confirm-modal-title="Émettre & Rembourser Stripe" data-confirm-modal-button="Confirmer & Rembourser">
				<input type="hidden" name="_token" value="{{ csrf_token('credit_note_issue_and_refund_' ~ entity.id) }}">
				<button type="submit" class="{{ layout == 'inline' ? 'text-indigo-400 hover:text-indigo-300' : 'w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-lg flex items-center justify-center gap-2 transition-all duration-200' }}" title="Émettre et rembourser via Stripe">
					{{ ux_icon('lucide:refresh-ccw', {class: layout == 'mobile' ? 'w-3.5 h-3.5' : 'w-4 h-4'}) }}
					{% if showText %}Émettre & Rembourser Stripe
					{% endif %}
				</button>
			</form>
		{% endif %}

		{# Bouton Émettre (DRAFT uniquement) - seulement si PAS de remboursement Stripe possible pour simplifier #}
		{% if is_granted('CREDIT_NOTE_ISSUE', entity) and entity.statutEnum.value == 'draft' and not isStripeRefundable %}
			<form action="{{ path('admin_credit_note_issue', {id: entity.id}) }}" method="POST" class="{{ layout == 'inline' ? 'inline' : (layout == 'mobile' ? 'contents' : 'w-full') }}">
				<input type="hidden" name="_token" value="{{ csrf_token('credit_note_issue_' ~ entity.id) }}">
				<button type="submit" class="{{ secondaryButtonClass }}" title="Émettre">
					{{ ux_icon('lucide:file-check', {class: layout == 'mobile' ? 'w-3.5 h-3.5' : 'w-4 h-4'}) }}
					{% if showText %}Émettre
					{% endif %}
				</button>
			</form>
		{% endif %}

		{# Bouton Émettre & Envoyer (DRAFT uniquement) - seulement si PAS de remboursement Stripe possible #}
		{% if is_granted('CREDIT_NOTE_ISSUE', entity) and entity.statutEnum.value == 'draft' and not isStripeRefundable and hasEmail %}
			<button type="button" class="{{ buttonClass }}" title="Émettre et envoyer" data-controller="email-trigger" data-email-trigger-url-value="{{ path('admin_credit_note_issue_and_send', {id: entity.id}) }}" data-email-trigger-csrf-token-value="{{ csrf_token('credit_note_issue_and_send_' ~ entity.id) }}" data-email-trigger-recipient-value="{{ recipientEmail }}" data-email-trigger-document-type-value="{{ type }}" data-email-trigger-document-number-value="{{ entity.number }}" data-action="click->email-trigger#open">
				{{ ux_icon('lucide:send', {class: layout == 'mobile' ? 'w-3.5 h-3.5' : 'w-4 h-4'}) }}
				{% if showText %}Émettre & Envoyer
				{% endif %}
			</button>
		{% endif %}

		{# Bouton Envoyer (ISSUED uniquement) #}
		{% if is_granted('CREDIT_NOTE_SEND', entity) and entity.statutEnum.value == 'issued' and hasEmail %}
			<button type="button" class="{{ buttonClass }}" title="Envoyer par email" data-controller="email-trigger" data-email-trigger-url-value="{{ path('admin_credit_note_send_email', {id: entity.id}) }}" data-email-trigger-csrf-token-value="{{ csrf_token('credit_note_send_email_' ~ entity.id) }}" data-email-trigger-recipient-value="{{ recipientEmail }}" data-email-trigger-document-type-value="{{ type }}" data-email-trigger-document-number-value="{{ entity.number }}" data-action="click->email-trigger#open">
				{{ ux_icon('lucide:mail', {class: layout == 'mobile' ? 'w-3.5 h-3.5' : 'w-4 h-4'}) }}
				{% if showText %}Envoyer l'avoir
				{% endif %}
			</button>
		{% endif %}

		{# Bouton Relancer (SENT uniquement) #}
		{% if entity.statutEnum.value == 'sent' and hasEmail %}
			<button type="button" class="{{ layout == 'inline' ? buttonClass : secondaryButtonClass }}" title="Relancer le client" data-controller="email-trigger" data-email-trigger-url-value="{{ path('admin_credit_note_send_email', {id: entity.id}) }}" data-email-trigger-csrf-token-value="{{ csrf_token('credit_note_send_email_' ~ entity.id) }}" data-email-trigger-recipient-value="{{ recipientEmail }}" data-email-trigger-document-type-value="{{ type }}" data-email-trigger-document-number-value="{{ entity.number }}" data-email-trigger-is-reminder-value="true" data-action="click->email-trigger#open">
				{{ ux_icon('lucide:bell', {class: layout == 'mobile' ? 'w-3.5 h-3.5' : 'w-4 h-4'}) }}
				{% if showText %}Relancer le client
				{% endif %}
			</button>
		{% endif %}

		{# Appliquer (ISSUED ou SENT) - Manuel #}
		{% if is_granted('CREDIT_NOTE_APPLY', entity) and entity.statutEnum.value in ['issued', 'sent'] and not entity.stripeRefundId %}
			<form action="{{ path('admin_credit_note_apply', {id: entity.id}) }}" method="POST" class="{{ layout == 'inline' ? 'inline' : (layout == 'mobile' ? 'contents' : 'w-full') }}" data-action="submit->confirm-modal#open" data-confirm-modal-message="Marquer cet avoir comme remboursé (virement/chèque manuel) ?">
				<input type="hidden" name="_token" value="{{ csrf_token('credit_note_apply_' ~ entity.id) }}">
				<button type="submit" class="{{ successButtonClass }}" title="Marquer comme remboursé">
					{{ ux_icon('lucide:check-circle', {class: layout == 'mobile' ? 'w-3.5 h-3.5' : 'w-4 h-4'}) }}
					{% if showText %}Remboursement Manuel
					{% endif %}
				</button>
			</form>
		{% endif %}

		{# Rembourser via Stripe (Si déjà émis mais pas encore remboursé) #}
		{% if isStripeRefundable and entity.statutEnum.value in ['issued', 'sent'] %}
			<form action="{{ path('admin_credit_note_issue_and_refund', {id: entity.id}) }}" method="POST" class="{{ layout == 'inline' ? 'inline' : (layout == 'mobile' ? 'contents' : 'w-full') }}" data-action="submit->confirm-modal#open" data-confirm-modal-message="Déclencher le remboursement Stripe pour cet avoir déjà émis ?">
				<input type="hidden" name="_token" value="{{ csrf_token('credit_note_issue_and_refund_' ~ entity.id) }}">
				<button type="submit" class="{{ layout == 'inline' ? 'text-indigo-400 hover:text-indigo-300' : 'w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-lg flex items-center justify-center gap-2 transition-all duration-200' }}" title="Rembourser via Stripe">
					{{ ux_icon('lucide:refresh-ccw', {class: layout == 'mobile' ? 'w-3.5 h-3.5' : 'w-4 h-4'}) }}
					{% if showText %}Rembourser via Stripe
					{% endif %}
				</button>
			</form>
		{% endif %}

		{# Badge Remboursé Stripe #}
		{% if entity.stripeRefundId and entity.refundStatus == 'succeeded' %}
			<div class="flex items-center gap-2 text-green-400 text-sm font-medium py-2 px-3 bg-green-400/10 rounded-lg">
				{{ ux_icon('lucide:check-circle', {class: 'w-4 h-4'}) }}
				Remboursé via Stripe
			</div>
		{% endif %}
	{% endif %}

	{# Bouton Annuler avec modal (commun) #}
	{% if is_granted(type|upper ~ '_CANCEL', entity) %}
		<button type="button" class="{{ dangerButtonClass }}" title="Annuler" data-controller="cancel-modal-trigger" data-action="click->cancel-modal-trigger#open" data-cancel-modal-trigger-url-value="{{ path('admin_' ~ type ~ '_cancel', {id: entity.id}) }}" data-cancel-modal-trigger-csrf-token-value="{{ csrf_token(type ~ '_cancel_' ~ entity.id) }}" data-cancel-modal-trigger-document-type-value="{{ type }}" data-cancel-modal-trigger-document-number-value="{{ type == 'credit_note' ? entity.number : entity.numero }}">
			{{ ux_icon('lucide:x-circle', {class: layout == 'mobile' ? 'w-3.5 h-3.5' : 'w-4 h-4'}) }}
			{% if showText %}Annuler
				{% if type == 'quote' %}le devis{% elseif type == 'invoice' %}la facture{% elseif type == 'amendment' %}l'avenant{% else %}l'avoir
				{% endif %}
			{% endif %}
		</button>
	{% endif %}

	{# Boutons supplémentaires pour Quote (show seulement) #}
	{% if type == 'quote' and layout == 'vertical' %}
		{# Créer un avenant #}
		{% if entity.statut.value == 'signed' %}
			<a href="{{ path('admin_amendment_new', {quote_id: entity.id}) }}" class="w-full btn-primary flex items-center justify-center gap-2">
				{{ ux_icon('lucide:file-edit', {class: layout == 'mobile' ? 'w-3.5 h-3.5' : 'w-4 h-4'}) }}
				Créer un avenant
			</a>
		{% endif %}

		{# Générer facture - seulement si pas de facture existante #}
		{% if is_granted('QUOTE_GENERATE_INVOICE', entity) and not entity.invoice %}
			<form action="{{ path('admin_quote_generate_invoice', {id: entity.id}) }}" method="POST" class="w-full" data-action="submit->confirm-modal#open" data-confirm-modal-message="Générer une facture depuis ce devis signé ?" data-confirm-modal-title="Confirmer la génération" data-confirm-modal-button="Générer">
				<input type="hidden" name="_token" value="{{ csrf_token('quote_generate_invoice_' ~ entity.id) }}">
				<button type="submit" class="w-full btn-success flex items-center justify-center gap-2">
					{{ ux_icon('lucide:receipt', {class: layout == 'mobile' ? 'w-3.5 h-3.5' : 'w-4 h-4'}) }}
					Générer une facture
				</button>
			</form>
		{% endif %}
	{% endif %}

	{# Bouton Télécharger PDF (vertical layout only) #}
	{% if layout == 'vertical' %}
		{% set isDraft = false %}

		{# Détecter si c'est un brouillon selon le type d'entité #}
		{% if entity.statut is defined %}
			{# Gérer le cas où statut est un objet ou une string #}
			{% if entity.statut.value is defined %}
				{% set isDraft = entity.statut.value == 'draft' %}
			{% else %}
				{% set isDraft = entity.statut == 'draft' %}
			{% endif %}
		{% elseif entity.statutEnum is defined %}
			{# Gérer le cas où statutEnum est un objet ou une string #}
			{% if entity.statutEnum.value is defined %}
				{% set isDraft = entity.statutEnum.value == 'draft' %}
			{% else %}
				{% set isDraft = entity.statutEnum == 'draft' %}
			{% endif %}
		{% endif %}

		{% set hasPdf = false %}

		{# Vérifier si le PDF existe selon le type #}
		{% if type == 'credit_note' %}
			{% set hasPdf = entity.pdfFilename is defined and entity.pdfFilename %}
		{% else %}
			{# Pour quote, amendment, invoice - le PDF est généré à l'émission #}
			{% set hasPdf = not isDraft %}
		{% endif %}

		{# Vérifier si le client a un email configuré #}
		{% set hasClientEmail = false %}
		{% if type == 'quote' or type == 'invoice' %}
			{% set hasClientEmail = entity.client is defined and entity.client and entity.client.email is defined and entity.client.email %}
		{% elseif type == 'amendment' %}
			{% set hasClientEmail = entity.quote is defined and entity.quote and entity.quote.client is defined and entity.quote.client and entity.quote.client.email is defined and entity.quote.client.email %}
		{% elseif type == 'credit_note' %}
			{% set hasClientEmail = entity.invoice is defined and entity.invoice and entity.invoice.client is defined and entity.invoice.client and entity.invoice.client.email is defined and entity.invoice.client.email %}
		{% endif %}

		{% if hasPdf %}
			<a href="{{ path('admin_' ~ type ~ '_download_pdf', {id: entity.id}) }}" class="w-full btn-secondary flex items-center justify-center gap-2" target="_blank">
				{{ ux_icon('lucide:download', {class: layout == 'mobile' ? 'w-3.5 h-3.5' : 'w-4 h-4'}) }}
				Télécharger le PDF
			</a>
		{% else %}
			<span class="w-full btn-secondary opacity-50 cursor-not-allowed flex items-center justify-center gap-2" title="Le PDF sera généré lors de l'émission">
				{{ ux_icon('lucide:download', {class: layout == 'mobile' ? 'w-3.5 h-3.5' : 'w-4 h-4'}) }}
				PDF non disponible
			</span>
		{% endif %}

		{# Hash PDF si disponible #}
		{% if entity.pdfHash is defined and entity.pdfHash %}
			<div class="text-xs text-white/40 break-all mt-2 text-center">
				<span title="Empreinte numérique SHA256 pour conformité légale">SHA256:
					{{ entity.pdfHash|slice(0, 16) }}...</span>
			</div>
		{% endif %}
	{% endif %}
</div>
